<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è–ªè³‡ç®¡ç†</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* è–ªè³‡ç®¡ç†ç‰¹å®šæ¨£å¼ */
    .salary-form {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .salary-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .salary-table th, .salary-table td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }

    .salary-table th {
      background-color: #f5f5f5;
    }

    .monthly-summary {
        margin-top: 30px;
        padding: 15px;
        background-color: #e9f5ff;
        border: 1px solid #b3d7ff;
        border-radius: var(--border-radius);
    }
    .monthly-summary h4 {
        margin-top: 0;
        color: #0056b3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>è–ªè³‡ç®¡ç† ğŸ’°</h2>

    <!-- å°è¦½åˆ— -->
    <div class="navbar">
      <button class="hamburger-menu" id="hamburger-menu">â˜°</button>
      <div class="nav-links" id="nav-links">
        <a href="notes.html" class="nav-link">æˆ‘çš„ç­†è¨˜</a>
        <a href="trash.html" class="nav-link">å›æ”¶ç«™</a>
        <a href="quotation.html" class="nav-link">ä¼°åƒ¹å–®</a>
        <a href="quotation-list.html" class="nav-link">ä¼°åƒ¹å–®æ¸…å–®</a>
        <a href="salary.html" class="nav-link active">è–ªè³‡ç®¡ç†</a>
        <button id="logout-btn" class="nav-link" onclick="signOut()" style="margin-left:auto;">ç™»å‡º</button>
      </div>
    </div>

    <!-- æ–°å¢è–ªè³‡è¡¨å–® -->
    <div class="salary-form">
      <h3>æ–°å¢è–ªè³‡è¨˜éŒ„</h3>
      <form id="salary-form">
        <div class="form-group">
          <label for="employee-name">å“¡å·¥å§“å</label>
          <input type="text" id="employee-name" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="salary-month">æœˆä»½</label>
          <input type="month" id="salary-month" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="salary-amount">è–ªè³‡é‡‘é¡</label>
          <input type="number" id="salary-amount" class="form-control" min="0" step="1" required>
        </div>
        <button type="submit" id="add-salary-btn">æ–°å¢è–ªè³‡</button>
      </form>
    </div>

    <!-- è–ªè³‡è¨˜éŒ„åˆ—è¡¨ -->
    <h3>è–ªè³‡è¨˜éŒ„</h3>
    <div id="salary-list-container">
      <!-- è–ªè³‡è¨˜éŒ„å°‡å‹•æ…‹è¼‰å…¥é€™è£¡ -->
      <p>è¼‰å…¥è–ªè³‡è¨˜éŒ„ä¸­...</p>
    </div>

    <!-- æ¯æœˆè–ªè³‡çµ±è¨ˆ -->
    <div class="monthly-summary" id="monthly-summary-container">
      <h4>æ¯æœˆè–ªè³‡æ”¯å‡ºçµ±è¨ˆ</h4>
      <div id="monthly-summary-content">
        <!-- æ¯æœˆçµ±è¨ˆå°‡å‹•æ…‹è¼‰å…¥é€™è£¡ -->
        <p>è¨ˆç®—çµ±è¨ˆä¸­...</p>
      </div>
    </div>

    <!-- è¼‰å…¥ä¸­é¡¯ç¤º -->
    <div class="loading-overlay" id="loading-overlay">
      <div class="loading-spinner"></div>
      <div class="loading-text">è™•ç†ä¸­...</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="script.js"></script>
  <script>
    let currentUser;

    // é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
    function showLoading() {
      const overlay = document.getElementById('loading-overlay');
      if (overlay) overlay.classList.add('active');
    }

    // éš±è—è¼‰å…¥ä¸­ç‹€æ…‹
    function hideLoading() {
      const overlay = document.getElementById('loading-overlay');
      if (overlay) overlay.classList.remove('active');
    }

    // åˆå§‹åŒ–é é¢
    document.addEventListener('DOMContentLoaded', async () => {
      currentUser = await checkAuthAndRedirect();
      if (!currentUser) return;

      // ç¶å®šç™»å‡ºæŒ‰éˆ•
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) logoutBtn.addEventListener('click', signOut);

      // ç¶å®šè¡¨å–®æäº¤äº‹ä»¶
      const salaryForm = document.getElementById('salary-form');
      if (salaryForm) salaryForm.addEventListener('submit', handleAddSalary);

      // è¼‰å…¥è–ªè³‡è¨˜éŒ„
      await loadSalaryData();
    });

    // è¼‰å…¥è–ªè³‡æ•¸æ“šä¸¦æ¸²æŸ“
    async function loadSalaryData() {
      showLoading();
      try {
        const { data, error } = await window.supabaseClient
          .from('salaries') // å‡è¨­è¡¨æ ¼åç¨±ç‚º 'salaries'
          .select('*')
          .eq('user_id', currentUser.id)
          .order('salary_month', { ascending: false }) // æŒ‰æœˆä»½é™åºæ’åˆ—
          .order('employee_name', { ascending: true }); // åŒæœˆä»½å…§æŒ‰å§“åæ’åº

        if (error) throw error;

        renderSalaryList(data || []);
        renderMonthlySummary(data || []);

      } catch (error) {
        console.error('è¼‰å…¥è–ªè³‡è¨˜éŒ„å¤±æ•—ï¼š', error);
        alert('âŒ è¼‰å…¥è–ªè³‡è¨˜éŒ„å¤±æ•—ï¼š' + error.message);
        document.getElementById('salary-list-container').innerHTML = '<p style="color: red;">ç„¡æ³•è¼‰å…¥è–ªè³‡è¨˜éŒ„ã€‚</p>';
        document.getElementById('monthly-summary-content').innerHTML = '<p style="color: red;">ç„¡æ³•è¨ˆç®—çµ±è¨ˆã€‚</p>';
      } finally {
        hideLoading();
      }
    }

    // æ¸²æŸ“è–ªè³‡åˆ—è¡¨
    function renderSalaryList(salaries) {
      const container = document.getElementById('salary-list-container');
      if (!container) return;

      if (salaries.length === 0) {
        container.innerHTML = '<p>ç›®å‰æ²’æœ‰è–ªè³‡è¨˜éŒ„ã€‚</p>';
        return;
      }

      let tableHTML = `
        <table class="salary-table">
          <thead>
            <tr>
              <th>æœˆä»½</th>
              <th>å“¡å·¥å§“å</th>
              <th>è–ªè³‡é‡‘é¡</th>
              <th>è¨˜éŒ„æ™‚é–“</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
      `;

      salaries.forEach(salary => {
        const salaryMonth = salary.salary_month || 'N/A'; // YYYY-MM æ ¼å¼
        const employeeName = salary.employee_name || 'N/A';
        const salaryAmount = salary.amount ? salary.amount.toLocaleString() : 'N/A';
        const createdAt = salary.created_at ? new Date(salary.created_at).toLocaleString() : 'N/A';

        tableHTML += `
          <tr>
            <td>${salaryMonth}</td>
            <td>${employeeName}</td>
            <td>${salaryAmount}</td>
            <td>${createdAt}</td>
            <td><button class="danger" onclick="deleteSalary(${salary.id})">åˆªé™¤</button></td>
          </tr>
        `;
      });

      tableHTML += `
          </tbody>
        </table>
      `;
      container.innerHTML = tableHTML;
    }

    // æ¸²æŸ“æ¯æœˆçµ±è¨ˆ
    function renderMonthlySummary(salaries) {
        const summaryContent = document.getElementById('monthly-summary-content');
        if (!summaryContent) return;

        if (salaries.length === 0) {
            summaryContent.innerHTML = '<p>æ²’æœ‰è³‡æ–™å¯ä¾›çµ±è¨ˆã€‚</p>';
            return;
        }

        const monthlyTotals = salaries.reduce((acc, salary) => {
            const month = salary.salary_month; // YYYY-MM
            if (!acc[month]) {
                acc[month] = 0;
            }
            acc[month] += salary.amount || 0;
            return acc;
        }, {});

        // æŒ‰æœˆä»½æ’åº (å¾æ–°åˆ°èˆŠ)
        const sortedMonths = Object.keys(monthlyTotals).sort().reverse();

        if (sortedMonths.length === 0) {
            summaryContent.innerHTML = '<p>æ²’æœ‰è³‡æ–™å¯ä¾›çµ±è¨ˆã€‚</p>';
            return;
        }

        let summaryHTML = '<ul>';
        sortedMonths.forEach(month => {
            summaryHTML += `<li><strong>${month}:</strong> ${monthlyTotals[month].toLocaleString()} å…ƒ</li>`;
        });
        summaryHTML += '</ul>';

        summaryContent.innerHTML = summaryHTML;
    }


    // è™•ç†æ–°å¢è–ªè³‡
    async function handleAddSalary(event) {
      event.preventDefault();
      showLoading();

      const employeeName = document.getElementById('employee-name').value.trim();
      const salaryMonth = document.getElementById('salary-month').value; // YYYY-MM
      const salaryAmount = parseFloat(document.getElementById('salary-amount').value);

      if (!employeeName || !salaryMonth || isNaN(salaryAmount) || salaryAmount < 0) {
        alert('è«‹ç¢ºä¿æ‰€æœ‰æ¬„ä½éƒ½å·²æ­£ç¢ºå¡«å¯«ã€‚');
        hideLoading();
        return;
      }

      try {
        const { error } = await window.supabaseClient
          .from('salaries')
          .insert([{
            user_id: currentUser.id,
            employee_name: employeeName,
            salary_month: salaryMonth,
            amount: salaryAmount
          }]);

        if (error) throw error;

        // æ¸…ç©ºè¡¨å–®
        document.getElementById('salary-form').reset();
        // é‡æ–°è¼‰å…¥æ•¸æ“š
        await loadSalaryData();

      } catch (error) {
        console.error('æ–°å¢è–ªè³‡å¤±æ•—ï¼š', error);
        alert('âŒ æ–°å¢è–ªè³‡å¤±æ•—ï¼š' + error.message);
      } finally {
        hideLoading();
      }
    }

    // åˆªé™¤è–ªè³‡è¨˜éŒ„
    async function deleteSalary(id) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è–ªè³‡è¨˜éŒ„å—ï¼Ÿ')) return;

        showLoading();
        try {
            const { error } = await window.supabaseClient
                .from('salaries')
                .delete()
                .eq('id', id)
                .eq('user_id', currentUser.id); // ç¢ºä¿åªèƒ½åˆªé™¤è‡ªå·±çš„è¨˜éŒ„

            if (error) throw error;

            // é‡æ–°è¼‰å…¥æ•¸æ“š
            await loadSalaryData();

        } catch (error) {
            console.error('åˆªé™¤è–ªè³‡è¨˜éŒ„å¤±æ•—ï¼š', error);
            alert('âŒ åˆªé™¤è–ªè³‡è¨˜éŒ„å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }

  </script>
</body>
</html>
