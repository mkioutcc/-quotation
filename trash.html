<!-- trash.html -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å›æ”¶ç«™</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h2>å›æ”¶ç«™ ğŸ—‘ï¸</h2>

    <!-- å°è¦½åˆ— -->
    <div class="navbar">
      <a href="notes.html" class="nav-link">æˆ‘çš„ç­†è¨˜</a>
      <a href="trash.html" class="nav-link active">å›æ”¶ç«™</a>
      <a href="quotation.html" class="nav-link">ä¼°åƒ¹å–®</a>
      <a href="quotation-list.html" class="nav-link">ä¼°åƒ¹å–®æ¸…å–®</a>
      <a href="salary.html" class="nav-link">è–ªè³‡ç®¡ç†</a>
      <button id="refresh-button" class="refresh-button" style="margin-right: auto;">ğŸ”„ åˆ·æ–°</button>
      <button id="logout-btn" class="nav-link" onclick="signOut()">ç™»å‡º</button>
    </div>

    <!-- å›æ”¶ç«™å…§å®¹ -->
    <div id="trash-list" class="notes-container">
      <!-- å›æ”¶ç«™ç­†è¨˜å°‡åœ¨é€™è£¡é¡¯ç¤º -->
    </div>

    <!-- ç§»é™¤åº•éƒ¨çš„ç™»å‡ºæŒ‰éˆ• -->
  </div>

  <!-- è¼‰å…¥ä¸­é¡¯ç¤º -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">è™•ç†ä¸­...</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="script.js"></script>
  <script>
    let currentUser;

    // é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
    function showLoading() {
      document.getElementById('loading-overlay').classList.add('active');
    }

    // éš±è—è¼‰å…¥ä¸­ç‹€æ…‹
    function hideLoading() {
      document.getElementById('loading-overlay').classList.remove('active');
    }

    // åˆå§‹åŒ–é é¢
    document.addEventListener('DOMContentLoaded', async () => {
      currentUser = await checkAuthAndRedirect();
      if (!currentUser) return;

      // ç¢ºä¿ supabaseClient å·²åˆå§‹åŒ–
      if (!window.supabaseClient) {
        console.error('Supabase client æœªåˆå§‹åŒ–');
        return;
      }

      // è¨­ç½®åˆ·æ–°æŒ‰éˆ•
      document.getElementById('refresh-button').addEventListener('click', () => {
        loadTrash();
      });

      // å»¶é²åŸ·è¡ŒæŸ¥è©¢ç¢ºä¿åˆå§‹åŒ–å®Œæˆ
      setTimeout(loadTrash, 100);
    });

    // è¼‰å…¥å›æ”¶ç«™
    async function loadTrash() {
      showLoading();
      try {
        const { data, error } = await window.supabaseClient
          .from('user_notes')
          .select('*')
          .eq('user_id', currentUser.id)
          .eq('is_deleted', true)
          .order('created_at', { ascending: false });

        if (error) throw error;

        renderTrash(data || []);
      } catch (error) {
        console.error('è¼‰å…¥å›æ”¶ç«™å¤±æ•—ï¼š', error);
        alert('âŒ è¼‰å…¥å›æ”¶ç«™å¤±æ•—ï¼š' + error.message);
      } finally {
        hideLoading();
      }
    }

    // æ¸²æŸ“å›æ”¶ç«™
    function renderTrash(trashNotes) {
      const list = document.getElementById('trash-list');
      list.innerHTML = '';

      if (trashNotes.length === 0) {
        list.innerHTML = '<div class="note-item">å›æ”¶ç«™æ˜¯ç©ºçš„</div>';
        return;
      }

      trashNotes.forEach(note => {
        const noteElement = document.createElement('div');
        noteElement.className = 'note-item';

        let tagsHtml = '';
        if (note.tags && Array.isArray(note.tags) && note.tags.length > 0) {
          tagsHtml = '<div class="note-tags">' +
            note.tags.map(tag => `<div class="tag">${tag}</div>`).join('') +
            '</div>';
        }

        noteElement.innerHTML = `
          <div class="note-content">${note.content}</div>
          ${tagsHtml}
          ${note.image_url ? `<img src="${note.image_url}" class="note-image">` : ''}
          <div class="note-actions">
            <button class="success" onclick="restoreNote(${note.id})">â™»ï¸ é‚„åŸ</button>
            <button class="danger" onclick="permanentlyDeleteNote(${note.id})">ğŸ—‘ æ°¸ä¹…åˆªé™¤</button>
          </div>
        `;

        list.appendChild(noteElement);
      });
    }

    // é‚„åŸç­†è¨˜
    async function restoreNote(id) {
      showLoading();
      try {
        const { error } = await window.supabaseClient
          .from('user_notes')
          .update({ is_deleted: false })
          .eq('id', id)
          .eq('user_id', currentUser.id);

        if (error) throw error;

        await loadTrash();
      } catch (error) {
        console.error('âŒ é‚„åŸå¤±æ•—ï¼š', error);
        alert('âŒ é‚„åŸå¤±æ•—ï¼š' + error.message);
      } finally {
        hideLoading();
      }
    }

    // æ°¸ä¹…åˆªé™¤ç­†è¨˜
    async function permanentlyDeleteNote(id) {
      const confirmDelete = confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™å‰‡ç­†è¨˜å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼');
      if (!confirmDelete) return;

      showLoading();
      try {
        const { error } = await window.supabaseClient
          .from('user_notes')
          .delete()
          .eq('id', id)
          .eq('user_id', currentUser.id);

        if (error) throw error;

        await loadTrash();
      } catch (error) {
        console.error('âŒ æ°¸ä¹…åˆªé™¤å¤±æ•—ï¼š', error);
        alert('âŒ æ°¸ä¹…åˆªé™¤å¤±æ•—ï¼š' + error.message);
      } finally {
        hideLoading();
      }
    }
  </script>
</body>
</html>
