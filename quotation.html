<!-- quotation.html -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¼°åƒ¹å–®ç³»çµ±</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* ä¼°åƒ¹å–®ç‰¹å®šæ¨£å¼ */
    .quotation-form {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }

    .form-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }

    .items-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }

    .items-table th, .items-table td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }

    .items-table th {
      background-color: #f5f5f5;
    }

    .items-table input {
      width: 100%;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 3px;
    }

    .items-table .subtotal {
      background-color: #f9f9f9;
    }

    .add-item-btn {
      margin-bottom: 15px;
    }

    .total-row {
      font-weight: bold;
      background-color: #f5f5f5;
    }

    .export-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .preview-container {
      margin-top: 30px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      background-color: #f9f9f9;
    }

    .preview-title {
      text-align: center;
      margin-bottom: 20px;
      font-size: 24px;
    }

   /* åˆ—å°æ¨£å¼ */
/* åˆ—å°æ¨£å¼ */
@page {
  size: A4;
  margin: 10mm; /* ä¿ç•™é é‚Šè· */
  /* å˜—è©¦ç§»é™¤é é¦–é å°¾ - æ•ˆæœä¾ç€è¦½å™¨è€Œå®š */
  @top-center { content: none; }
  @bottom-center { content: none; }
}

@media print {

/* --- 1. åŸºç¤è¨­å®šï¼šéš±è—éåˆ—å°å…§å®¹ --- */

/* å…ˆéš±è— body ä¸‹çš„æ‰€æœ‰å…§å®¹ */
body {
   visibility: hidden !important;
}
/* ç§»é™¤ç•«é¢ä¸Šéåˆ—å°å€çš„é‚Šç•Œ/å…§è· */
html, body {
   margin: 0 !important;
   padding: 0 !important;
   background: white !important; /* ç¢ºä¿èƒŒæ™¯æ˜¯ç™½è‰² */
}

/* --- 2. é¡¯ç¤ºåˆ—å°å€å¡Šä¸¦å®šä½ --- */

/* ä½¿ print-section åŠå…¶å…§å®¹å¯è¦‹ */
.print-section, .print-section * {
   visibility: visible !important;
   /* !! é‡è¦ï¼šå˜—è©¦å¼·åˆ¶åˆ—å°èƒŒæ™¯é¡è‰²å’Œåœ–ç‰‡ !! */
   /* ç•¶ä½¿ç”¨è€…åœ¨åˆ—å°å°è©±æ¡†å‹¾é¸ã€ŒèƒŒæ™¯åœ–å½¢ã€æ™‚ï¼Œé€™æœƒæç¤ºç€è¦½å™¨ä½¿ç”¨åŸå§‹é¡è‰² */
   -webkit-print-color-adjust: exact !important; /* Chrome, Safari, Edge */
   color-adjust: exact !important;             /* Standard (Firefox) */
}

/* å°‡ print-section æ‹‰åˆ°ç•«é¢çš„æœ€é ‚å±¤ã€å·¦å´ */
.print-section {
  position: absolute !important; /* ä½¿ç”¨çµ•å°å®šä½ç¢ºä¿å®ƒåœ¨æœ€ä¸Šå±¤ */
  left: 0 !important;
  top: 0 !important;
  width: 100% !important; /* ä½”æ»¿å¯¬åº¦ */
  margin: 0 !important;  /* ç§»é™¤å¤–é‚Šè· */
  padding: 10mm !important; /* ä½¿ç”¨é é¢é‚Šç•Œä½œç‚ºå…§è· */
  border: none !important; /* ç§»é™¤é‚Šæ¡† */
  box-shadow: none !important; /* ç§»é™¤é™°å½± */
  background-color: white !important; /* è¨­å®šåŸºç¤èƒŒæ™¯ç‚ºç™½è‰² */
  font-size: 10pt; /* è¨­å®šåŸºæœ¬å­—å‹å¤§å° */
  color: black !important; /* ç¢ºä¿æ–‡å­—ç‚ºé»‘è‰² */
  display: block !important; /* ç¢ºä¿æ˜¯å€å¡Šå…ƒç´  */
  box-sizing: border-box !important; /* ç¢ºä¿ padding ä¸æœƒå¢åŠ å¯¬åº¦ */
  /* æ–°å¢ï¼šç¢ºä¿å…§å®¹åœ¨é é¢å…§ */
  overflow: hidden !important;
}
/* --- é‡å°ç‰¹å®šå…ƒç´ ï¼šéš±è—éœæ…‹çš„é è¦½æ¨™é¡Œ --- */
.print-section > .preview-title {
  display: none !important; /* åœ¨åˆ—å°æ™‚éš±è—é€™å€‹ç‰¹å®šçš„æ¨™é¡Œ */
}
/* --- 3. åˆ—å°å€å¡Šå…§éƒ¨å…ƒç´ æ¨£å¼èª¿æ•´ --- */

/* æ¨™é¡Œæ¨£å¼ */
.print-section .preview-title {
    font-size: 18pt !important;
    font-weight: bold !important;
    text-align: center !important;
    margin-bottom: 15px !important;
}

/* è¡¨æ ¼æ¨£å¼ */
.print-section .items-table {
  width: 100% !important;
  border-collapse: collapse !important;
  margin-top: 10px !important;
  page-break-inside: auto !important; /* å…è¨±è¡¨æ ¼è·¨é  */
  table-layout: fixed; /* æ–°å¢ï¼šå›ºå®šè¡¨æ ¼ä½ˆå±€ï¼Œé˜²æ­¢å…§å®¹æ’é–‹ */
  word-wrap: break-word; /* æ–°å¢ï¼šç¢ºä¿é•·æ–‡å­—èƒ½æ›è¡Œ */
}

/* è¡¨æ ¼å„²å­˜æ ¼ (th, td) æ¨£å¼ */
.print-section .items-table th,
.print-section .items-table td {
  border: 1px solid #000 !important; /* é»‘è‰²é‚Šæ¡† */
  padding: 3px 4px !important; /* ç¨å¾®æ¸›å°‘å…§è· */
  font-size: 8pt !important; /* ç¨å¾®ç¸®å°å­—é«” */
  word-wrap: break-word !important; /* è‡ªå‹•æ›è¡Œ */
  text-align: left !important; /* é è¨­å·¦å°é½Š */
  vertical-align: top !important; /* å‚ç›´é ä¸Šå°é½Š */
  color: black !important; /* ç¢ºä¿æ–‡å­—é¡è‰² */
  /* æ–°å¢ï¼šè™•ç†å¯èƒ½çš„æº¢å‡º */
  overflow: hidden;
  text-overflow: ellipsis; /* å¯é¸ï¼šç”¨çœç•¥è™Ÿé¡¯ç¤ºæº¢å‡ºæ–‡å­— */
}

/* ç‰¹å®šæ¬„ä½æ–‡å­—å°é½Š (æ•¸é‡ã€å–®åƒ¹ã€ç¸½åƒ¹é å³) */
.print-section .items-table td:nth-child(3), /* æ•¸é‡æ¬„ */
.print-section .items-table td:nth-child(4), /* å–®åƒ¹æ¬„ */
.print-section .items-table td:nth-child(5) { /* ç¸½åƒ¹æ¬„ */
    text-align: right !important;
}

/* è¡¨æ ¼æ¨™é ­ (th) æ¨£å¼ */
.print-section .items-table th {
    /* !! èƒŒæ™¯è‰²ï¼šå¦‚æœæ‚¨å¸Œæœ›åˆ—å°æ™‚æ¨™é ­æ˜¯ç°è‰²ï¼Œè«‹å–æ¶ˆè¨»è§£ä¸‹é¢é€™è¡Œ !! */
    /* background-color: #eee !important; */
    /* å¦‚æœæ‚¨å¸Œæœ›æ¨™é ­èƒ½å°å‡ºå®ƒåŸæœ¬çš„é¡è‰²(å¦‚æœæœ‰çš„è©±)ï¼Œå°±ä¿æŒè¨»è§£æˆ–åˆªé™¤ä¸Šé¢é‚£è¡Œ */
    font-weight: bold !important;
    text-align: center !important; /* è¡¨é ­æ–‡å­—ç½®ä¸­ */
}

/* é‡å°ç‰¹å®šèƒŒæ™¯è‰²çš„å€å¡Š (ä¾‹å¦‚é»ƒè‰²ã€æ©˜è‰²å€å¡Š) */
/* æˆ‘å€‘ä¸å†å¼·åˆ¶è¨­å®šèƒŒæ™¯è‰²ï¼Œè®“ç€è¦½å™¨æ ¹æ“šåŸå§‹æ¨£å¼å’Œã€ŒèƒŒæ™¯åœ–å½¢ã€è¨­å®šæ±ºå®š */
.print-section div[style*="background:#ffff99"], /* ç›®æ¨™é»ƒè‰²å€å¡Š */
.print-section div[style*="background:#f4a460"] { /* ç›®æ¨™æ©˜è‰²å€å¡Š */
   /* ç§»é™¤æˆ–è¨»è§£æ‰äº† background-color çš„è¦†è“‹ */

   /* ä¿ç•™å…¶ä»–åˆ—å°èª¿æ•´ (ä¾‹å¦‚é‚Šæ¡†) */
   border: 1px solid #ccc !important; /* å¦‚æœå¸Œæœ›åˆ—å°æ™‚æœ‰é‚Šæ¡† */
   padding: 5px !important;
   margin-top: 10px !important;
   margin-bottom: 10px !important;
}

 /* é å³å°é½Šçš„ç¸½è¨ˆæ–‡å­— */
 .print-section div[style*="text-align:right"] {
     text-align: right !important;
     font-weight: bold !important;
     margin-top: 10px !important;
 }

 /* å°‡ flex ä½ˆå±€æ”¹ç‚º block ä½ˆå±€ (é€šå¸¸åœ¨åˆ—å°ä¸­æ›´ç©©å®š) */
 .print-section div[style*="display:flex"] {
     display: block !important;
 }
 /* è™•ç†åŸæœ¬ space-between çš„å…ƒç´ é–“è· */
 .print-section div[style*="justify-content:space-between"] > div {
     margin-bottom: 5px !important;
 }
 /* è™•ç†ç°½åå€æ¨£å¼ */
 .print-section div[style*="justify-content:space-around"] {
      margin-top: 30px !important;
      padding-top: 15px !important;
      border-top: 1px solid #000 !important;
      display: block !important; /* ç¢ºä¿æ˜¯ block */
 }
 /* ç°½åå€å¡Šå…§çš„å…ƒç´  */
  .print-section div[style*="justify-content:space-around"] > div {
      margin-bottom: 10px !important;
      width: 100% !important; /* è®“ç°½åè¡Œä½”æ»¿å¯¬åº¦ */
  }
  

/* --- 4. é¿å…åˆ—å°ä¸å¿…è¦çš„å…ƒç´  (å¦‚æœæœ‰çš„è©±) --- */
/* ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨ç¢ºå®šé‚„æœ‰å…¶ä»–å…ƒç´ éœ€è¦éš±è—ï¼Œå¯ä»¥åœ¨é€™è£¡æ·»åŠ  */
/* .some-other-element-to-hide-in-print { display: none !important; } */

}
/* ================== åˆ—å°æ¨£å¼çµæŸ ================== */
    
  </style>
</head>
<body>
  <div class="container">
    <h2>ä¼°åƒ¹å–®ç³»çµ± ğŸ“</h2>

    <!-- å°è¦½åˆ— -->
    <div class="navbar">
       <button class="hamburger-menu" id="hamburger-menu">â˜°</button>
       <div class="nav-links" id="nav-links">
         <a href="notes.html" class="nav-link">æˆ‘çš„ç­†è¨˜</a>
         <a href="trash.html" class="nav-link">å›æ”¶ç«™</a>
         <a href="quotation.html" class="nav-link active">ä¼°åƒ¹å–®</a>
         <a href="quotation-list.html" class="nav-link">ä¼°åƒ¹å–®æ¸…å–®</a>
         <a href="salary.html" class="nav-link">è–ªè³‡ç®¡ç†</a>
         <button id="logout-btn" class="nav-link" onclick="signOut()" style="margin-left:auto;">ç™»å‡º</button> <!-- onclick added for consistency -->
       </div>
    </div>

    <!-- ä¼°åƒ¹å–®è¡¨å–® -->
    <div class="quotation-form">
      <form id="quotation-form">
        <div class="form-row">
          <div class="form-group">
            <label for="quotation-title">å ±åƒ¹åç¨±</label>
            <input type="text" id="quotation-title" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="customer-name">å®¢æˆ¶åç¨±</label>
            <input type="text" id="customer-name" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="contact-person">è¯çµ¡äºº</label>
            <input type="text" id="contact-person" class="form-control">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="contact-phone">è¯çµ¡é›»è©±</label>
            <input type="text" id="contact-phone" class="form-control">
          </div>
          <div class="form-group">
            <label for="quotation-date">å ±åƒ¹æ—¥æœŸ</label>
            <input type="date" id="quotation-date" class="form-control" required>
          </div>
        </div>

        <h3>å“é …åˆ—è¡¨</h3>
        <div class="table-responsive"> <!-- æ–°å¢ï¼šè¡¨æ ¼å®¹å™¨ -->
          <table class="items-table" id="items-table">
            <thead>
              <tr>
                <th>åç¨±</th>
                <th>è¦æ ¼</th>
                <th>æ•¸é‡</th>
                <th>å–®åƒ¹</th>
                <th>ç¸½åƒ¹</th>
                <th>å‚™è¨»</th>
                <th></th>
            </tr>
          </thead>
          <tbody id="items-body">
            <!-- å“é …å°‡åœ¨é€™è£¡å‹•æ…‹æ·»åŠ  -->
          </tbody>
          <tfoot>
            <tr class="total-row">
              <td colspan="4" style="text-align: right;">ç¸½è¨ˆï¼š</td> <!-- èª¿æ•´ colspan -->
              <td id="total-amount">0</td>
              <td colspan="2"></td> <!-- èª¿æ•´ colspan -->
            </tr>
            </tfoot>
          </table>
        </div> <!-- æ–°å¢ï¼šé—œé–‰è¡¨æ ¼å®¹å™¨ -->

        <button type="button" id="add-item-btn" class="add-item-btn">+ æ–°å¢å“é …</button>

        <div class="export-buttons">
          <button type="button" id="preview-btn">é è¦½</button>
          <button type="button" id="save-quotation-btn">å„²å­˜ä¼°åƒ¹å–®</button>
          <!-- Removed Excel Export Button -->
          <!-- ç§»é™¤åŒ¯å‡º PDF æŒ‰éˆ• -->
          <button type="button" id="print-btn">åˆ—å°</button>
        </div>
      </form>
    </div>

    <!-- é è¦½å€åŸŸ -->
    <div class="preview-container" id="preview-container" style="display: none;">
      <div class="preview-title">å¤§ç™¼å ±åƒ¹å–®</div>
      <div id="preview-content"></div>
    </div>

    <!-- è¼‰å…¥ä¸­é¡¯ç¤º -->
    <div class="loading-overlay" id="loading-overlay">
      <div class="loading-spinner"></div>
      <div class="loading-text">è™•ç†ä¸­...</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <!-- Removed XLSX Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="script.js"></script> <!-- script.js åŒ…å« checkAuthAndRedirect å’Œ supabaseClient åˆå§‹åŒ– -->
  <script>
    // Supabase is initialized in script.js as window.supabaseClient

    let currentUser;

    // é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
    function showLoading() {
      const overlay = document.getElementById('loading-overlay');
      if (overlay) overlay.classList.add('active');
    }

    // éš±è—è¼‰å…¥ä¸­ç‹€æ…‹
    function hideLoading() {
      const overlay = document.getElementById('loading-overlay');
      if (overlay) overlay.classList.remove('active');
    }

        // åˆå§‹åŒ–é é¢
    document.addEventListener('DOMContentLoaded', () => {
      // éé˜»å¡ç™»å…¥æª¢æŸ¥
      if (typeof checkAuthAndRedirect === 'function') {
        checkAuthAndRedirect().then(user => {
          currentUser = user; // ä¿å­˜ç”¨æˆ¶ä¿¡æ¯
          console.log('User check complete:', currentUser);
        }).catch(e => console.warn('ç™»å…¥æª¢æŸ¥å¤±æ•—ï¼Œè·³é', e));
      } else {
        console.warn('checkAuthAndRedirect å‡½æ•¸æœªå®šç¾©');
      }

      // ç¶å®šç™»å‡ºæŒ‰éˆ•
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) logoutBtn.addEventListener('click', () => {
        if (typeof signOut === 'function') {
          signOut();
        } else {
          console.error('signOut å‡½æ•¸æœªå®šç¾©');
        }
      });

      // è¨­ç½®ç•¶å‰æ—¥æœŸ
      const today = new Date().toISOString().split('T')[0];
      const dateInput = document.getElementById('quotation-date');
      if (dateInput) {
        dateInput.value = today;
      } else {
        console.error('æ‰¾ä¸åˆ°æ—¥æœŸè¼¸å…¥æ¡† #quotation-date');
      }

      // !! ä¿®æ”¹é–‹å§‹ï¼šæ·»åŠ æŒ‡å®šæ•¸é‡çš„åˆå§‹ç©ºç™½å“é … !!
      const initialRowCount = 8; // è¨­å®šæ‚¨æƒ³è¦çš„åˆå§‹ç©ºç™½åˆ—æ•¸
      const itemsBody = document.getElementById('items-body');

      if (itemsBody) { // ç¢ºä¿å“é …è¡¨æ ¼çš„ tbody å­˜åœ¨
        console.log(`æº–å‚™æ·»åŠ  ${initialRowCount} å€‹åˆå§‹ç©ºç™½å“é …...`);
        for (let i = 0; i < initialRowCount; i++) {
          addNewItem(); // é‡è¤‡å‘¼å«ç¾æœ‰çš„ addNewItem å‡½æ•¸
        }
        console.log(`å·²æˆåŠŸæ·»åŠ  ${initialRowCount} å€‹åˆå§‹ç©ºç™½å“é …ã€‚`);
      } else {
        console.error('æ‰¾ä¸åˆ° #items-body å…ƒç´ ä¾†æ·»åŠ åˆå§‹å“é …');
      }
      // !! ä¿®æ”¹çµæŸ !!

      // ç¶å®šæŒ‰éˆ•äº‹ä»¶ (ç¢ºä¿å…ƒç´ å­˜åœ¨)
      const addItemBtn = document.getElementById('add-item-btn');
      if (addItemBtn) addItemBtn.addEventListener('click', addNewItem);
      else console.error('æ‰¾ä¸åˆ°æŒ‰éˆ• #add-item-btn');

      const previewBtn = document.getElementById('preview-btn');
      if (previewBtn) previewBtn.addEventListener('click', previewQuotation);
      else console.error('æ‰¾ä¸åˆ°æŒ‰éˆ• #preview-btn');

      const saveBtn = document.getElementById('save-quotation-btn');
      if (saveBtn) saveBtn.addEventListener('click', saveQuotation);
      else console.error('æ‰¾ä¸åˆ°æŒ‰éˆ• #save-quotation-btn');

      // Removed Excel Export Button Listener
      // ç§»é™¤ PDF æŒ‰éˆ•ç›£è½å™¨

      const printBtn = document.getElementById('print-btn');
      if (printBtn) printBtn.addEventListener('click', printQuotation);
      else console.error('æ‰¾ä¸åˆ°æŒ‰éˆ• #print-btn');

      // åˆå§‹åŒ–æ™‚è¨ˆç®—ä¸€æ¬¡ç¸½è¨ˆ (å› ç‚º addNewItem å…§éƒ¨æœƒè§¸ç™¼è¨ˆç®—)
      // calculateTotal(); // é€™è¡Œç¾åœ¨æ˜¯å¤šé¤˜çš„ï¼Œå› ç‚ºè¿´åœˆä¸­çš„ addNewItem å·²è§¸ç™¼è¨ˆç®—
    });

    // ... (saveQuotation, addNewItem, removeItem, calculateSubtotal, calculateTotal, getFormData, validateForm, previewQuotation, exportToPDF, printQuotation ç­‰å‡½æ•¸ä¿æŒä¸è®Š) ...

     // å„²å­˜ä¼°åƒ¹å–®åˆ° Supabase
     async function saveQuotation() {
      console.log('saveQuotation called');
      // 1. å…ˆé©—è­‰è¡¨å–® (ç¢ºä¿è‡³å°‘æœ‰ä¸€è¡Œæœ‰æ•ˆæ•¸æ“š)
      if (!validateForm()) return;

      // 2. ç²å–è¡¨å–®æ•¸æ“š (getFormData ç¾åœ¨æœƒéæ¿¾æ‰ç©ºç™½è¡Œ)
      const data = getFormData();
      console.log('è¦å„²å­˜çš„è¡¨å–®æ•¸æ“š (å·²éæ¿¾ç©ºç™½è¡Œ):', data);

      // ç¢ºä¿ supabaseClient ç‰©ä»¶å­˜åœ¨
      if (!window.supabaseClient) {
          console.error('Supabase client (window.supabaseClient) is not initialized.');
          alert('Supabase æœªåˆå§‹åŒ–ï¼Œç„¡æ³•å„²å­˜');
          return;
      }
      console.log('Supabase client found:', window.supabaseClient);

      // æª¢æŸ¥éæ¿¾å¾Œæ˜¯å¦é‚„æœ‰å“é … (ç†è«–ä¸Š validateForm å·²è™•ç†ï¼Œä½†å¤šä¸€å±¤ä¿éšª)
      if (data.items.length === 0) {
          console.warn('getFormData éæ¿¾å¾Œæ²’æœ‰å“é …ï¼Œé›–ç„¶ validateForm æ‡‰è©²å·²é˜»æ­¢ã€‚ä¸åŸ·è¡Œå„²å­˜ã€‚');
          alert('æ²’æœ‰æœ‰æ•ˆçš„å“é …å¯å„²å­˜ã€‚');
          return;
      }


      showLoading();
      try {
          // ç¢ºä¿ currentUser å’Œ currentUser.id å­˜åœ¨
          if (!currentUser || !currentUser.id) {
              alert('ç„¡æ³•ç²å–ä½¿ç”¨è€…è³‡è¨Šï¼Œè«‹é‡æ–°ç™»å…¥å¾Œå†è©¦ã€‚');
              hideLoading();
              return;
          }

          // ä½¿ç”¨ window.supabaseClient
          const { data: insertData, error } = await window.supabaseClient.from('quotations').insert({
            user_id: currentUser.id, // **æ–°å¢ user_id**
            quotation_title: data.quotationTitle,
            customer_name: data.customerName,
            contact_person: data.contactPerson, // ç¢ºä¿æ¬„ä½åç¨±èˆ‡è³‡æ–™åº«ä¸€è‡´
            contact_phone: data.contactPhone,   // ç¢ºä¿æ¬„ä½åç¨±èˆ‡è³‡æ–™åº«ä¸€è‡´
            date: data.quotationDate,
            items: data.items, // é€™è£¡çš„ items å·²ç¶“æ˜¯éæ¿¾å¾Œçš„
            total: data.total  // é€™è£¡çš„ total ä¹Ÿæ˜¯åŸºæ–¼éæ¿¾å¾Œçš„ items è¨ˆç®—çš„
          }).select();

          if (error) {
            console.error('å„²å­˜å¤±æ•—:', error);
            alert('å„²å­˜å¤±æ•—ï¼š' + error.message);
          } else {
            console.log('å„²å­˜æˆåŠŸ:', insertData);
            alert('ä¼°åƒ¹å–®å·²æˆåŠŸå„²å­˜ï¼');
            // å¯é¸ï¼šå„²å­˜æˆåŠŸå¾Œæ¸…ç©ºè¡¨å–®æˆ–è·³è½‰
             document.getElementById('quotation-form').reset();
            // // æ¸…ç©ºå¾Œé‡æ–°æ·»åŠ åˆå§‹ç©ºç™½è¡Œ
             const initialRowCount = 8;
             const itemsBody = document.getElementById('items-body');
             if (itemsBody) {
                 itemsBody.innerHTML = ''; // æ¸…ç©ºç¾æœ‰è¡Œ
                 for (let i = 0; i < initialRowCount; i++) {
                   addNewItem();
                 }
             }
          }
      } catch (err) {
          console.error('å„²å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
          alert('å„²å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + err.message);
      } finally {
          hideLoading();
      }
    }

    // æ·»åŠ æ–°å“é …
    function addNewItem() {
      const itemsBody = document.getElementById('items-body');
      if (!itemsBody) {
        console.error('æ‰¾ä¸åˆ° #items-body');
        return;
      }

      const newRow = itemsBody.insertRow();
      newRow.innerHTML = `
        <td><input type="text" class="item-name" required></td>
        <td><input type="text" class="item-spec"></td>
        <td><input type="number" class="item-quantity" value="1" min="1" required></td>
        <td><input type="number" class="item-price" value="0" min="0" step="0.01" required></td>
        <td class="subtotal">0.00</td> <!-- é è¨­å€¼ -->
        <td><input type="text" class="item-note"></td>
        <td><button type="button" class="danger remove-item-btn">Ã—</button></td>
      `;

      // æ·»åŠ äº‹ä»¶ç›£è½å™¨ä»¥è¨ˆç®—å°è¨ˆå’Œç§»é™¤æŒ‰éˆ•
      const quantityInput = newRow.querySelector('.item-quantity');
      const priceInput = newRow.querySelector('.item-price');
      const removeBtn = newRow.querySelector('.remove-item-btn');

      if (quantityInput) quantityInput.addEventListener('input', () => calculateSubtotal(newRow));
      else console.error('æ‰¾ä¸åˆ° .item-quantity in new row');

      if (priceInput) priceInput.addEventListener('input', () => calculateSubtotal(newRow));
      else console.error('æ‰¾ä¸åˆ° .item-price in new row');

      if (removeBtn) removeBtn.addEventListener('click', () => removeItem(removeBtn));
      else console.error('æ‰¾ä¸åˆ° .remove-item-btn in new row');

      // ç«‹å³è¨ˆç®—ä¸€æ¬¡å°è¨ˆå’Œç¸½è¨ˆ
      calculateSubtotal(newRow);
    }

    // ç§»é™¤å“é …
    function removeItem(button) {
      const row = button.closest('tr');
      if (row && row.parentNode) { // ç¢ºä¿ row å’Œ parentNode å­˜åœ¨
        row.parentNode.removeChild(row);
        calculateTotal();
      } else {
        console.error('ç„¡æ³•æ‰¾åˆ°è¦ç§»é™¤çš„è¡Œ');
      }
    }

    // è¨ˆç®—å–®è¡Œå°è¨ˆ
    function calculateSubtotal(row) {
      const quantityInput = row.querySelector('.item-quantity');
      const priceInput = row.querySelector('.item-price');
      const subtotalCell = row.querySelector('.subtotal');

      if (!quantityInput || !priceInput || !subtotalCell) {
        console.error('è¨ˆç®—å°è¨ˆæ™‚æ‰¾ä¸åˆ°å…ƒç´  in row:', row);
        return;
      }

      const quantity = parseFloat(quantityInput.value) || 0;
      const price = parseFloat(priceInput.value) || 0;
      const subtotal = quantity * price;

      subtotalCell.textContent = subtotal.toFixed(2);
      calculateTotal();
    }

    // è¨ˆç®—ç¸½è¨ˆ
    function calculateTotal() {
      const totalAmountCell = document.getElementById('total-amount');
      if (!totalAmountCell) {
        console.error('æ‰¾ä¸åˆ° #total-amount');
        return;
      }

      const subtotals = document.querySelectorAll('#items-body .subtotal');
      let total = 0;

      subtotals.forEach(cell => {
        total += parseFloat(cell.textContent) || 0;
      });

      totalAmountCell.textContent = total.toFixed(2);
    }

    // ç²å–è¡¨å–®æ•¸æ“š
    function getFormData() {
      const customerName = document.getElementById('customer-name')?.value || '';
      const contactPerson = document.getElementById('contact-person')?.value || '';
      const contactPhone = document.getElementById('contact-phone')?.value || '';
      const quotationDate = document.getElementById('quotation-date')?.value || '';

      const items = []; // é€™å€‹é™£åˆ—åªæœƒåŒ…å«æœ‰å¡«å¯«åç¨±çš„å“é …
      const rows = document.getElementById('items-body')?.rows;

      if (rows) {
          for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const nameInput = row.querySelector('.item-name');
            // **é—œéµï¼šç²å–åç¨±ä¸¦å»é™¤å‰å¾Œç©ºç™½**
            const name = nameInput ? nameInput.value.trim() : '';

            // **é—œéµï¼šåªæœ‰ç•¶åç¨±ä¸æ˜¯ç©ºç™½æ™‚ï¼Œæ‰è™•ç†é€™ä¸€è¡Œä¸¦åŠ å…¥ items é™£åˆ—**
            if (name !== '') {
                const specInput = row.querySelector('.item-spec');
                const quantityInput = row.querySelector('.item-quantity');
                const priceInput = row.querySelector('.item-price');
                const noteInput = row.querySelector('.item-note');

                const spec = specInput ? specInput.value : '';
                // å¦‚æœæ•¸é‡/åƒ¹æ ¼ç‚ºç©ºï¼Œçµ¦äºˆé è¨­å€¼ 0
                const quantity = quantityInput ? (parseFloat(quantityInput.value) || 0) : 0;
                const price = priceInput ? (parseFloat(priceInput.value) || 0) : 0;
                const subtotal = quantity * price; // é‡æ–°è¨ˆç®—ç¢ºä¿æº–ç¢º
                const note = noteInput ? noteInput.value : '';

                items.push({
                  name, // ä½¿ç”¨ trim éçš„ name
                  spec,
                  quantity,
                  price,
                  subtotal,
                  note
                });
            }
            // å¦‚æœ name æ˜¯ç©ºç™½ï¼Œå‰‡ç›´æ¥è·³éé€™ä¸€è¡Œï¼Œä¸åŠ å…¥ items é™£åˆ—
          }
      }

      // **é—œéµï¼šåŸºæ–¼éæ¿¾å¾Œçš„ items é™£åˆ—ä¾†è¨ˆç®—æœ€çµ‚è¦å„²å­˜çš„ç¸½è¨ˆ**
      const total = items.reduce((sum, item) => sum + item.subtotal, 0);

      // æ³¨æ„ï¼šé€™è£¡ä¸éœ€è¦æ›´æ–°ç•«é¢ä¸Šçš„ç¸½è¨ˆæ¬„ä½ (#total-amount)ï¼Œ
      // ç•«é¢ä¸Šçš„ç¸½è¨ˆç”± calculateTotal() å‡½æ•¸è² è²¬ï¼Œå®ƒæœƒè¨ˆç®—æ‰€æœ‰è¡Œçš„ç¸½å’Œã€‚
      // é€™å€‹å‡½æ•¸è¿”å›çš„ total æ˜¯å°ˆé–€çµ¦å„²å­˜ã€é è¦½ã€åŒ¯å‡ºä½¿ç”¨çš„ã€‚
      // æ›´æ–°é¡¯ç¤ºçš„ç¸½è¨ˆ
      const totalAmountCell = document.getElementById('total-amount');
      if (totalAmountCell) totalAmountCell.textContent = total.toFixed(2);


      return {
        quotationTitle: document.getElementById('quotation-title')?.value || '',
        customerName,
        contactPerson,
        contactPhone,
        quotationDate,
        items: items, // è¿”å›åªåŒ…å«æœ‰æ•ˆå“é …çš„é™£åˆ—
        total: total  // è¿”å›åŸºæ–¼æœ‰æ•ˆå“é …è¨ˆç®—çš„ç¸½é¡
      };
    }

    // é©—è­‰è¡¨å–®
    function validateForm() {
      console.log('åŸ·è¡Œ validateForm é©—è­‰...'); // å¢åŠ æ—¥èªŒ

      // 1. é©—è­‰å®¢æˆ¶åç¨±å’Œå ±åƒ¹æ—¥æœŸç­‰éå“é …å¿…å¡«æ¬„ä½
      const form = document.getElementById('quotation-form');
      if (!form) {
        console.error('æ‰¾ä¸åˆ°è¡¨å–® #quotation-form');
        return false;
      }
      // é¸æ“‡å™¨ï¼šé¸æ“‡æ‰€æœ‰æœ‰ required å±¬æ€§ï¼Œä½†ä¸æ˜¯å“é …åç¨±ã€æ•¸é‡ã€åƒ¹æ ¼çš„ input
      const requiredInputs = form.querySelectorAll('input[required]:not(.item-name):not(.item-quantity):not(.item-price)');
      let firstInvalidInput = null;

      for (let input of requiredInputs) {
        if (!input.value.trim()) {
          if (!firstInvalidInput) firstInvalidInput = input; // è¨˜éŒ„ç¬¬ä¸€å€‹ç„¡æ•ˆè¼¸å…¥
          // è¦–è¦ºæç¤ºï¼šæ”¹è®Šé‚Šæ¡†é¡è‰²
          input.style.borderColor = 'red';
        } else {
          input.style.borderColor = ''; // æ¢å¾©æ­£å¸¸é‚Šæ¡†
        }
      }

      if (firstInvalidInput) {
          alert('è«‹å¡«å¯«å®¢æˆ¶åç¨±å’Œå ±åƒ¹æ—¥æœŸç­‰å¿…å¡«æ¬„ä½ï¼ˆç´…è‰²é‚Šæ¡†æ¨™ç¤ºï¼‰');
          firstInvalidInput.focus();
          console.log('é©—è­‰å¤±æ•—ï¼šéå“é …å¿…å¡«æ¬„ä½æœªå¡«å¯«ã€‚');
          return false;
      }

      // 2. é©—è­‰æ˜¯å¦è‡³å°‘å¡«å¯«äº†ä¸€å€‹å“é …çš„åç¨±
      const itemsBody = document.getElementById('items-body');
      let hasValidItem = false;
      let firstEmptyItemNameInput = null; // ç”¨æ–¼èšç„¦

      if (itemsBody && itemsBody.rows.length > 0) {
          const itemRows = itemsBody.rows;
          for(let i = 0; i < itemRows.length; i++) {
              const nameInput = itemRows[i].querySelector('.item-name');
              // æª¢æŸ¥åç¨±å»é™¤ç©ºç™½å¾Œæ˜¯å¦éç©º
              if (nameInput && nameInput.value.trim() !== '') {
                  hasValidItem = true;
                  // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„éŒ¯èª¤æç¤ºæ¨£å¼
                  nameInput.style.borderColor = '';
                  // ä¸éœ€è¦èšç„¦ï¼Œå› ç‚ºæ‰¾åˆ°æœ‰æ•ˆçš„äº†
                  break; // æ‰¾åˆ°ä¸€å€‹æœ‰æ•ˆçš„å°±å¤ äº†
              } else if (nameInput && !firstEmptyItemNameInput) {
                  // è¨˜éŒ„ç¬¬ä¸€å€‹ç©ºç™½çš„å“é …åç¨±è¼¸å…¥æ¡†ï¼Œä»¥ä¾¿å¾ŒçºŒèšç„¦
                  firstEmptyItemNameInput = nameInput;
              }
          }
      }

      if (!hasValidItem) {
          alert('è«‹è‡³å°‘å¡«å¯«ä¸€å€‹å“é …çš„åç¨±');
          // èšç„¦åˆ°ç¬¬ä¸€å€‹ç©ºç™½çš„å“é …åç¨±è¼¸å…¥æ¡†ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
          if (firstEmptyItemNameInput) {
              firstEmptyItemNameInput.style.borderColor = 'red'; // æç¤ºä½¿ç”¨è€…
              firstEmptyItemNameInput.focus();
          } else if (itemsBody && itemsBody.rows.length > 0) {
              // å¦‚æœæ‰€æœ‰è¡Œéƒ½å­˜åœ¨ä½†éƒ½æ²’æ‰¾åˆ° .item-name (ç†è«–ä¸Šä¸å¤ªå¯èƒ½)
              const fallbackInput = itemsBody.querySelector('.item-name');
              if (fallbackInput) fallbackInput.focus();
              else document.getElementById('add-item-btn')?.focus();
          }
          else {
               // å¦‚æœé€£ä¸€è¡Œéƒ½æ²’æœ‰ï¼Œèšç„¦æ–°å¢æŒ‰éˆ•
               document.getElementById('add-item-btn')?.focus();
          }
          console.log('é©—è­‰å¤±æ•—ï¼šæœªå¡«å¯«ä»»ä½•æœ‰æ•ˆå“é …åç¨±ã€‚');
          return false;
      }

      // æ‰€æœ‰é©—è­‰é€šé
      console.log('validateForm é©—è­‰é€šéã€‚');
      return true;
    }

    // é è¦½ä¼°åƒ¹å–® (ä½¿ç”¨éæ¿¾å¾Œçš„æ•¸æ“š)
    function previewQuotation() {
      console.log('previewQuotation called');
      // 1. å…ˆåŸ·è¡Œè¡¨å–®é©—è­‰
      if (!validateForm()) {
        console.log('é è¦½ä¸­æ­¢ï¼Œå› ç‚ºè¡¨å–®é©—è­‰æœªé€šéã€‚');
        return;
      }

      // 2. ç²å–éæ¿¾å¾Œçš„è¡¨å–®æ•¸æ“š
      const data = getFormData();
      const previewContainer = document.getElementById('preview-container');
      const previewContent = document.getElementById('preview-content');

      if (!previewContainer || !previewContent) {
        console.error('æ‰¾ä¸åˆ°é è¦½å®¹å™¨æˆ–å…§å®¹å…ƒç´ ');
        return;
      }

      // 3. è™•ç†æ²’æœ‰æœ‰æ•ˆå“é …çš„æƒ…æ³ (é›–ç„¶ validateForm æ‡‰è©²å·²é˜»æ­¢ï¼Œä½†åšå€‹ä¿éšª)
      if (data.items.length === 0) {
           console.warn('é è¦½ä¸­æ­¢ï¼Œå› ç‚º getFormData è¿”å›äº† 0 å€‹æœ‰æ•ˆå“é …ã€‚');
           previewContent.innerHTML = '<p style="text-align:center; color: red; padding: 20px;">è«‹è‡³å°‘å¡«å¯«ä¸€å€‹æœ‰æ•ˆçš„å“é …å¾Œå†é è¦½ã€‚</p>';
           previewContainer.style.display = 'block';
           previewContainer.scrollIntoView({ behavior: 'smooth' });
           return;
      }

      // 4. ç”Ÿæˆé è¦½å…§å®¹çš„ HTML (ä½¿ç”¨éæ¿¾å¾Œçš„ data.items å’Œ data.total)
      let html = `
        <div style="text-align:center; font-size:24px; font-weight:bold; margin-bottom:10px;">å¤§ç™¼é‹¼æ§‹æœ‰é™å…¬å¸</div>
        <div style="text-align:center; font-size:18px; background:#f4a460; padding:5px; margin-bottom:10px;">å ±åƒ¹å–®</div>
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
          <div>
            <p><strong>å ±åƒ¹åç¨±ï¼š</strong>${data.quotationTitle || 'N/A'}</p>
            <p><strong>å®¢æˆ¶åç¨±ï¼š</strong>${data.customerName || 'N/A'}</p>
            <p><strong>è¯çµ¡äººï¼š</strong>${data.contactPerson || 'N/A'}</p>
            <p><strong>é›»è©±ï¼š</strong>${data.contactPhone || 'N/A'}</p>
          </div>
          <div>
            <p><strong>å ±åƒ¹æ—¥æœŸï¼š</strong>${data.quotationDate || 'N/A'}</p>
          </div>
        </div>
        <div style="background:#ffff99; padding:5px; margin-bottom:10px;">
          <p><strong>å ±åƒ¹æ–¹è³‡è¨Šï¼š</strong></p>
          <p>å…¬å¸åç¨±ï¼šå¤§ç™¼é‹¼æ§‹æœ‰é™å…¬å¸</p>
          <p>åœ°å€ï¼šå½°åŒ–ç¸£åŸ¤é ­é„‰å¹³åŸæ‘ç¨»é¦™è·¯464å··28è™Ÿ</p>
          <p>é›»è©±ï¼š09-20552261</p>
        </div>
        <table class="items-table" style="width:100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="border: 1px solid #000; padding: 5px; background-color: #eee;">åç¨±</th>
              <th style="border: 1px solid #000; padding: 5px; background-color: #eee;">è¦æ ¼</th>
              <th style="border: 1px solid #000; padding: 5px; background-color: #eee; text-align: center;">æ•¸é‡</th>
              <th style="border: 1px solid #000; padding: 5px; background-color: #eee; text-align: right;">å–®åƒ¹</th>
              <th style="border: 1px solid #000; padding: 5px; background-color: #eee; text-align: right;">ç¸½åƒ¹</th>
              <th style="border: 1px solid #000; padding: 5px; background-color: #eee;">å‚™è¨»</th>
            </tr>
          </thead>
          <tbody>
      `;

      data.items.forEach(item => {
        html += `
          <tr>
            <td style="border: 1px solid #000; padding: 5px;">${item.name || ''}</td>
            <td style="border: 1px solid #000; padding: 5px;">${item.spec || ''}</td>
            <td style="border: 1px solid #000; padding: 5px; text-align: center;">${item.quantity}</td>
            <td style="border: 1px solid #000; padding: 5px; text-align: right;">${item.price.toFixed(2)}</td>
            <td style="border: 1px solid #000; padding: 5px; text-align: right;">${item.subtotal.toFixed(2)}</td>
            <td style="border: 1px solid #000; padding: 5px;">${item.note || ''}</td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
        <div style="margin-top:10px; font-weight:bold; text-align:right; padding-right:10px;">ç¸½è¨ˆæ–°å°å¹£ï¼š${data.total.toFixed(2)}å…ƒæ•´</div>
        <div style="background:#ffff99; padding:5px; margin-top:10px;">
          <p><strong>é™„è¨»ï¼š</strong></p>
          <p>1.ä»¥ä¸Šå–®åƒ¹æœªç¨…åƒ¹.  ä»¥ä¸Šä¼°ç®—å ±åƒ¹ä¸å«æœªè©³åˆ—ä¹‹å·¥é …å·¥ç¨‹ã€‚</p>
          <p>2.ç°½ç´„åŒæ™‚æ”¯ä»˜ç¸½å·¥ç¨‹æ¬¾ä¹‹30%(ç¾é‡‘ç¥¨)</p>
          <p>3.è£½ä½œå®Œæˆé€²å ´æŒ‰è£å†æ”¯ä»˜ç¸½å·¥ç¨‹æ¬¾ä¹‹40%(ç¾é‡‘ç¥¨)</p>
          <p>4.æŒ‰è£å®Œæˆå†æ”¯ä»˜ç¸½å·¥ç¨‹æ¬¾ä¹‹30%(ç¾é‡‘ç¥¨)</p>
          <p>5.æœ¬å·¥ç¨‹7å¤©å…§é©—æ”¶å®Œç•¢ä»˜æ¸…å°¾æ¬¾(ç¾é‡‘ç¥¨)</p>
          <p>6.å¦‚å·²å®Œæˆå» å…§è£½ä½œï¼ŒæƒŸå› å…¶ä»–å·¥ç¨‹å»¶èª¤ï¼Œè‡´ç„¡æ³•é€²å ´å®‰è£ï¼Œä»é ˆä¾é …2æ”¯ä»˜ç¸½å·¥ç¨‹æ¬¾ä¹‹40%</p>
          <p>7.æ­¤å–®ç¢ºèªå›å‚³å¾Œï¼Œç¤ºç‚ºè²´å¸éµå®ˆä»¥ä¸Šä¹‹ç´„å®šã€‚</p>
        </div>
        <div style="margin-top:40px; padding-top: 20px; border-top: 1px solid #ccc; display:flex; justify-content:space-around;">
          <div>ä»˜æ¬¾æ–¹å¼ï¼š_________________________</div>
          <div>å®¢æˆ¶ç¢ºèªç°½åï¼š_________________________</div>
        </div>
      `;

      // 5. å°‡ç”Ÿæˆçš„ HTML æ”¾å…¥é è¦½å®¹å™¨ä¸¦é¡¯ç¤º
      previewContent.innerHTML = html;
      previewContainer.style.display = 'block';

      // 6. æ»¾å‹•åˆ°é è¦½å€åŸŸ
      previewContainer.scrollIntoView({ behavior: 'smooth' });
      console.log('é è¦½å…§å®¹å·²ç”Ÿæˆä¸¦é¡¯ç¤ºã€‚');
    }

    // ç§»é™¤ exportToPDF å‡½æ•¸
    // function exportToPDF() { ... }

    // åˆ—å°ä¼°åƒ¹å–® (èª¿ç”¨ previewQuotation)
    function printQuotation() {
      console.log('printQuotation called');
      // 1. å…ˆé©—è­‰è¡¨å–®
      if (!validateForm()){
         console.log('åŒ¯å‡º PDF ä¸­æ­¢ï¼Œå› ç‚ºè¡¨å–®é©—è­‰æœªé€šéã€‚');
         return;
      }

      showLoading(); // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹

      try {
        // 2. ç²å–éæ¿¾å¾Œçš„è¡¨å–®æ•¸æ“š
        const data = getFormData();

        // 3. è™•ç†æ²’æœ‰æœ‰æ•ˆå“é …çš„æƒ…æ³ (ä¿éšª)
        if (data.items.length === 0) {
            console.warn('åŒ¯å‡º PDF ä¸­æ­¢ï¼Œå› ç‚º getFormData è¿”å›äº† 0 å€‹æœ‰æ•ˆå“é …ã€‚');
            alert('æ²’æœ‰æœ‰æ•ˆçš„å“é …å¯åŒ¯å‡º PDFã€‚');
            hideLoading();
            return;
        }

        const { jsPDF } = window.jspdf;

        // 4. å‰µå»º PDF æ–‡ä»¶
        const doc = new jsPDF({
            orientation: 'p', // portrait
            unit: 'mm',
            format: 'a4'
        });

        // --- æ·»åŠ å­—é«” ---
        // !! é‡è¦ï¼šè¦æ­£ç¢ºé¡¯ç¤ºä¸­æ–‡ï¼Œéœ€è¦è¼‰å…¥æ”¯æ´ä¸­æ–‡çš„å­—å‹æª” !!
        // ä¸‹é¢æ˜¯è¨­ç½®å­—å‹çš„ç¯„ä¾‹ï¼Œä½† 'NotoSansTC' å¿…é ˆå…ˆè¢«è¼‰å…¥åˆ° jsPDF ä¸­
        // ä¾‹å¦‚ï¼Œé€šé addFont() æ–¹æ³•è¼‰å…¥ base64 ç·¨ç¢¼çš„å­—å‹æª”
        // ç”±æ–¼ç„¡æ³•ç›´æ¥æ·»åŠ å­—å‹æª”ï¼Œé€™è£¡åƒ…ä½œç‚ºç¯„ä¾‹ï¼Œå¯¦éš›æ•ˆæœå–æ±ºæ–¼ç’°å¢ƒä¸­æ˜¯å¦å·²è¼‰å…¥å­—å‹
        try {
             // å˜—è©¦è¨­ç½®ä¸€å€‹å¯èƒ½å­˜åœ¨çš„å­—é«”åç¨± (æ•ˆæœä¸ä¿è­‰)
             // åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œæ‚¨éœ€è¦ç¢ºä¿ 'NotoSansTC' æˆ–å…¶ä»–ä¸­æ–‡å­—é«”å·²é€šé addFont æ­£ç¢ºè¼‰å…¥
             doc.setFont('NotoSansTC', 'normal');
             console.log("Attempted to set font to NotoSansTC.");
        } catch (e) {
             console.error("Failed to set font 'NotoSansTC'. Make sure the font is loaded.", e);
             // å¯ä»¥å˜—è©¦å›é€€åˆ° jsPDF å¯èƒ½å…§å»ºä½†ä¸æ”¯æ´ä¸­æ–‡çš„å­—é«”
             doc.setFont('helvetica', 'normal');
        }

        // 5. æ·»åŠ å…§å®¹åˆ° PDF (èˆ‡ previewQuotation é¡ä¼¼çš„çµæ§‹)
        doc.setFontSize(18);
        doc.text('å¤§ç™¼é‹¼æ§‹æœ‰é™å…¬å¸', doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
        doc.setFontSize(14); // å ±åƒ¹å–®æ¨™é¡Œå¯ä»¥å°ä¸€é»
        doc.setFillColor(244, 164, 96); // æ©˜è‰² (è¿‘ä¼¼ #f4a460)
        doc.rect(15, 20, doc.internal.pageSize.getWidth() - 30, 8, 'F'); // èƒŒæ™¯çŸ©å½¢
        doc.setTextColor(0, 0, 0); // æ–‡å­—é¡è‰²æ¢å¾©é»‘è‰²
        doc.text('å ±åƒ¹å–®', doc.internal.pageSize.getWidth() / 2, 25, { align: 'center' });

        doc.setFontSize(10); // å®¢æˆ¶ä¿¡æ¯å­—é«”
        let startY = 35;
        doc.text(`å®¢æˆ¶åç¨±ï¼š${data.customerName || 'N/A'}`, 15, startY);
        doc.text(`å ±åƒ¹æ—¥æœŸï¼š${data.quotationDate || 'N/A'}`, doc.internal.pageSize.getWidth() - 15, startY, { align: 'right' });
        startY += 7;
        doc.text(`è¯çµ¡äººï¼š${data.contactPerson || 'N/A'}`, 15, startY);
        startY += 7;
        doc.text(`è¯çµ¡é›»è©±ï¼š${data.contactPhone || 'N/A'}`, 15, startY);
        startY += 10;

        // å ±åƒ¹æ–¹è³‡è¨Šå€å¡Š
        doc.setFillColor(255, 255, 153); // æ·¡é»ƒè‰² (è¿‘ä¼¼ #ffff99)
        const infoBoxHeight = 20; // ä¼°è¨ˆé«˜åº¦
        doc.rect(15, startY, doc.internal.pageSize.getWidth() - 30, infoBoxHeight, 'F');
        doc.setTextColor(0, 0, 0);
        doc.text('å ±åƒ¹æ–¹è³‡è¨Šï¼š', 20, startY + 5);
        doc.text('å…¬å¸åç¨±ï¼šå¤§ç™¼é‹¼æ§‹æœ‰é™å…¬å¸', 20, startY + 10);
        doc.text('åœ°å€ï¼šå½°åŒ–ç¸£åŸ¤é ­é„‰å¹³åŸæ‘ç¨»é¦™è·¯464å··28è™Ÿ', 20, startY + 15);
        // doc.text('é›»è©±ï¼š09-20552261', 20, startY + 20); // å¦‚æœç©ºé–“å¤ 
        startY += infoBoxHeight + 5;

        // æº–å‚™è¡¨æ ¼æ•¸æ“š (ä½¿ç”¨éæ¿¾å¾Œçš„ data.items)
        const tableData = data.items.map(item => [
          item.name || '',
          item.spec || '',
          item.quantity.toString(),
          item.price.toFixed(2),
          item.subtotal.toFixed(2),
          item.note || ''
        ]);

        // ä½¿ç”¨ autotable æ’ä»¶å‰µå»ºè¡¨æ ¼
        doc.autoTable({
          head: [['åç¨±', 'è¦æ ¼', 'æ•¸é‡', 'å–®åƒ¹', 'ç¸½åƒ¹', 'å‚™è¨»']],
          body: tableData,
          startY: startY,
          theme: 'grid',
          headStyles: { fillColor: [238, 238, 238], textColor: 0, fontStyle: 'bold', halign: 'center' }, // ç°è‰²è¡¨é ­, ç½®ä¸­
          styles: { fontSize: 9, cellPadding: 2, overflow: 'linebreak', lineColor: [0, 0, 0], lineWidth: 0.1 }, // é»‘è‰²ç´°ç¶²æ ¼ç·š
          columnStyles: {
            0: { cellWidth: 40 }, // åç¨±
            1: { cellWidth: 40 }, // è¦æ ¼
            2: { cellWidth: 15, halign: 'center' }, // æ•¸é‡
            3: { cellWidth: 25, halign: 'right' }, // å–®åƒ¹
            4: { cellWidth: 25, halign: 'right' }, // ç¸½åƒ¹
            5: { cellWidth: 'auto' } // å‚™è¨»
          },
          didDrawPage: function(hookData) {
            // å¯ä»¥åœ¨é€™è£¡æ·»åŠ é ç¢¼ç­‰
          }
        });

        // ç²å–è¡¨æ ¼çµæŸçš„ Y åº§æ¨™
        let finalY = doc.lastAutoTable.finalY;

        // æ·»åŠ ç¸½è¨ˆ (ä½¿ç”¨éæ¿¾å¾Œçš„ data.total)
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text(`ç¸½è¨ˆæ–°å°å¹£ï¼š${data.total.toFixed(2)}å…ƒæ•´`, doc.internal.pageSize.getWidth() - 15, finalY + 8, { align: 'right' });
        doc.setFont(undefined, 'normal');
        finalY += 15;

        // é™„è¨»å€å¡Š
        const notes = [
          '1.ä»¥ä¸Šå–®åƒ¹æœªç¨…åƒ¹.  ä»¥ä¸Šä¼°ç®—å ±åƒ¹ä¸å«æœªè©³åˆ—ä¹‹å·¥é …å·¥ç¨‹ã€‚',
          '2.ç°½ç´„åŒæ™‚æ”¯ä»˜ç¸½å·¥ç¨‹æ¬¾ä¹‹30%(ç¾é‡‘ç¥¨)',
          '3.è£½ä½œå®Œæˆé€²å ´æŒ‰è£å†æ”¯ä»˜ç¸½å·¥ç¨‹æ¬¾ä¹‹40%(ç¾é‡‘ç¥¨)',
          '4.æŒ‰è£å®Œæˆå†æ”¯ä»˜ç¸½å·¥ç¨‹æ¬¾ä¹‹30%(ç¾é‡‘ç¥¨)',
          '5.æœ¬å·¥ç¨‹7å¤©å…§é©—æ”¶å®Œç•¢ä»˜æ¸…å°¾æ¬¾(ç¾é‡‘ç¥¨)',
          '6.å¦‚å·²å®Œæˆå» å…§è£½ä½œï¼ŒæƒŸå› å…¶ä»–å·¥ç¨‹å»¶èª¤ï¼Œè‡´ç„¡æ³•é€²å ´å®‰è£ï¼Œä»é ˆä¾é …2æ”¯ä»˜ç¸½å·¥ç¨‹æ¬¾ä¹‹40%',
          '7.æ­¤å–®ç¢ºèªå›å‚³å¾Œï¼Œç¤ºç‚ºè²´å¸éµå®ˆä»¥ä¸Šä¹‹ç´„å®šã€‚'
        ];
        const noteLineHeight = 5;
        const notePadding = 5;
        const noteBoxHeight = notes.length * noteLineHeight + notePadding * 2;
        doc.setFillColor(255, 255, 153); // æ·¡é»ƒè‰²
        doc.rect(15, finalY, doc.internal.pageSize.getWidth() - 30, noteBoxHeight, 'F');
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(8);
        doc.text('é™„è¨»ï¼š', 20, finalY + notePadding);
        let noteY = finalY + notePadding + noteLineHeight;
        notes.forEach(note => {
            // æª¢æŸ¥æ˜¯å¦éœ€è¦æ›é 
            if (noteY > doc.internal.pageSize.getHeight() - 15) { // é ç•™é åº•é‚Šè·
                doc.addPage();
                noteY = 15; // æ–°é é¢çš„èµ·å§‹ Y åº§æ¨™
            }
            doc.text(note, 20, noteY);
            noteY += noteLineHeight;
        });
        finalY += noteBoxHeight + 15; // å¢åŠ é–“éš”

        // æª¢æŸ¥ç°½åæ¬„æ˜¯å¦éœ€è¦æ›é 
        if (finalY > doc.internal.pageSize.getHeight() - 20) {
            doc.addPage();
            finalY = 20; // æ–°é é¢çš„èµ·å§‹ Y åº§æ¨™
        }

        // ç°½åæ¬„
        doc.setLineWidth(0.2); // ç°½åç·šå¯¬åº¦
        doc.line(35, finalY + 2, 90, finalY + 2); // ä»˜æ¬¾æ–¹å¼ç·š
        doc.line(doc.internal.pageSize.getWidth() / 2 + 35, finalY + 2, doc.internal.pageSize.getWidth() - 25, finalY + 2); // å®¢æˆ¶ç°½åç·š
        doc.setFontSize(10);
        doc.text('ä»˜æ¬¾æ–¹å¼ï¼š', 15, finalY);
        doc.text('å®¢æˆ¶ç¢ºèªç°½åï¼š', doc.internal.pageSize.getWidth() / 2 + 5, finalY);

        // 6. ç”Ÿæˆæ–‡ä»¶åä¸¦ä¿å­˜ PDF
        const fileName = `ä¼°åƒ¹å–®_${data.customerName || 'æœªå‘½åå®¢æˆ¶'}_${data.quotationDate || 'ç„¡æ—¥æœŸ'}.pdf`;
        doc.save(fileName);
        console.log(`PDF å·²åŒ¯å‡º: ${fileName}`);

      } catch (error) {
        console.error('åŒ¯å‡º PDF å¤±æ•—ï¼š', error);
        alert('åŒ¯å‡º PDF å¤±æ•—ï¼š' + error.message);
      } finally {
        hideLoading(); // éš±è—è¼‰å…¥ç‹€æ…‹
      }
    }

    // åˆ—å°ä¼°åƒ¹å–® (èª¿ç”¨ previewQuotation)
    function printQuotation() {
      console.log('printQuotation called');
      // 1. å…ˆé©—è­‰è¡¨å–®
      if (!validateForm()) {
        console.log('åˆ—å°ä¸­æ­¢ï¼Œå› ç‚ºè¡¨å–®é©—è­‰æœªé€šéã€‚');
        return;
      }

      // 2. å‘¼å«é è¦½å‡½æ•¸ä¾†ç”Ÿæˆ/æ›´æ–°å…§å®¹ä¸¦é¡¯ç¤ºé è¦½å€å¡Š
      // previewQuotation å…§éƒ¨æœƒè™•ç†é©—è­‰å’Œç²å–æ•¸æ“š
      previewQuotation();

      const previewContainer = document.getElementById('preview-container');
      if (!previewContainer) {
        console.error('æ‰¾ä¸åˆ°é è¦½å®¹å™¨ #preview-container');
        return;
      }

      // æª¢æŸ¥é è¦½å…§å®¹æ˜¯å¦å› ç‚ºæ²’æœ‰æœ‰æ•ˆå“é …è€Œè¢«æ¸…ç©ºäº†
      const previewContent = document.getElementById('preview-content');
      if (previewContent && previewContent.textContent.includes('æ²’æœ‰æœ‰æ•ˆçš„å“é …å¯é è¦½')) {
          console.log('åˆ—å°ä¸­æ­¢ï¼Œå› ç‚ºé è¦½å…§å®¹é¡¯ç¤ºæ²’æœ‰æœ‰æ•ˆå“é …ã€‚');
          return; // å¦‚æœé è¦½é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯ï¼Œå‰‡ä¸è§¸ç™¼åˆ—å°
      }

      // 3. æ·»åŠ ç”¨æ–¼åˆ—å°çš„ CSS class
      previewContainer.classList.add('print-section');
      console.log('Added print-section class for printing.');

      // 4. ä½¿ç”¨å»¶é²ç¢ºä¿æ¨£å¼æ‡‰ç”¨
      setTimeout(() => {
        try {
          // 5. è§¸ç™¼ç€è¦½å™¨åˆ—å°
          console.log('Calling window.print()...');
          window.print();
          console.log('window.print() called successfully.');
        } catch (error) {
          console.error('èª¿ç”¨ window.print() æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
          alert('ç„¡æ³•å•Ÿå‹•åˆ—å°åŠŸèƒ½: ' + error.message);
        } finally {
          // 6. æ¸…ç†ï¼šç§»é™¤åˆ—å° class (ç„¡è«–æˆåŠŸæˆ–å¤±æ•—)
          // ä½¿ç”¨ requestAnimationFrame ç¢ºä¿åœ¨ä¸‹ä¸€å€‹ç¹ªè£½å¹€ç§»é™¤ï¼Œ
          // é¿å…åœ¨ print() é˜»å¡æ™‚éæ—©ç§»é™¤
          requestAnimationFrame(() => {
              previewContainer.classList.remove('print-section');
              console.log('Removed print-section class after print attempt.');
          });
          // é€™è£¡ä¸å†æ¢å¾© display ç‹€æ…‹ï¼Œè®“ previewQuotation æ±ºå®šæ˜¯å¦é¡¯ç¤º
        }
      }, 100); // ç¨å¾®å»¶é²ä»¥ç¢ºä¿ class è¢«æ‡‰ç”¨
    }

    // æ¨è–¦ï¼šæ·»åŠ  afterprint äº‹ä»¶ç›£è½å™¨åšæœ€çµ‚æ¸…ç†
    window.addEventListener('afterprint', () => {
        const previewContainer = document.getElementById('preview-container');
        if (previewContainer && previewContainer.classList.contains('print-section')) {
            previewContainer.classList.remove('print-section');
            console.log('Cleaned up print-section class via afterprint event.');
        }
    });
  </script>
</body>
</html>
