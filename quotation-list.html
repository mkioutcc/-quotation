<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¼°åƒ¹å–®æ¸…å–®</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .quotation-list-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .quotation-list-table th, .quotation-list-table td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }
    .quotation-list-table th {
      background-color: #f5f5f5;
    }
    .quotation-list-table tbody tr:hover {
      background-color: #f9f9f9;
      cursor: pointer;
    }
    .quotation-detail-modal {
      /* æ²¿ç”¨ notes.html çš„ modal æ¨£å¼ */
    }
    .quotation-detail-content {
       /* æ²¿ç”¨ notes.html çš„ modal-content æ¨£å¼ */
       max-height: 80vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
       overflow-y: auto; /* è¶…å‡ºæ™‚é¡¯ç¤ºæ»¾å‹•æ¢ */
    }
    .quotation-detail-header {
       /* æ²¿ç”¨ notes.html çš„ modal-header æ¨£å¼ */
    }
    .quotation-detail-close {
       /* æ²¿ç”¨ notes.html çš„ modal-close æ¨£å¼ */
    }
    /* ä¼°åƒ¹å–®è©³æƒ…è¡¨æ ¼æ¨£å¼ (å¯æ²¿ç”¨ quotation.html çš„ items-table) */
    .detail-items-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    .detail-items-table th, .detail-items-table td {
        padding: 8px;
        border: 1px solid #ccc;
        text-align: left;
        font-size: 0.9em;
    }
    .detail-items-table th {
        background-color: #f0f0f0;
    }
    .detail-total {
        font-weight: bold;
        text-align: right;
        margin-top: 10px;
    }

   /* --- åˆ—å°æ¨£å¼ (å¾ quotation.html è¤‡è£½éä¾†) --- */
    @page {
      size: A4;
      margin: 10mm; /* ä¿ç•™é é‚Šè· */
      /* å˜—è©¦ç§»é™¤é é¦–é å°¾ - æ•ˆæœä¾ç€è¦½å™¨è€Œå®š */
      @top-center { content: none; }
      @bottom-center { content: none; }
    }

    @media print {

    /* --- 1. åŸºç¤è¨­å®šï¼šéš±è—éåˆ—å°å…§å®¹ --- */
    body > *:not(.print-section) { /* éš±è— body ä¸‹é™¤äº† print-section ä»¥å¤–çš„æ‰€æœ‰ç›´æ¥å­å…ƒç´  */
       display: none !important;
       visibility: hidden !important;
    }
    html, body {
       margin: 0 !important;
       padding: 0 !important;
       background: white !important;
    }

    /* --- 2. é¡¯ç¤ºåˆ—å°å€å¡Šä¸¦å®šä½ --- */
    .print-section, .print-section * {
       visibility: visible !important;
       -webkit-print-color-adjust: exact !important;
       color-adjust: exact !important;
    }
    .print-section {
      position: absolute !important;
      left: 0 !important;
      top: 0 !important;
      width: 100% !important;
      margin: 0 !important;
      padding: 10mm !important;
      border: none !important;
      box-shadow: none !important;
      background-color: white !important;
      font-size: 10pt !important;
      color: black !important;
      display: block !important;
      box-sizing: border-box !important;
      overflow: hidden !important;
    }
    .print-section > .preview-title { /* å‡è¨­åˆ—å°å…§å®¹ä¸­æœ‰æ­¤ class */
      display: none !important;
    }

    /* --- 3. åˆ—å°å€å¡Šå…§éƒ¨å…ƒç´ æ¨£å¼èª¿æ•´ --- */
    .print-section .preview-title { /* å‡è¨­åˆ—å°å…§å®¹ä¸­æœ‰æ­¤ class */
        font-size: 18pt !important;
        font-weight: bold !important;
        text-align: center !important;
        margin-bottom: 15px !important;
    }
    .print-section .items-table, /* æ‡‰ç”¨æ–¼è¤‡è£½éä¾†çš„è¡¨æ ¼ */
    .print-section .detail-items-table { /* ä¹Ÿæ‡‰ç”¨æ–¼è©³æƒ…è¡¨æ ¼ */
      width: 100% !important;
      border-collapse: collapse !important;
      margin-top: 10px !important;
      page-break-inside: auto !important;
      table-layout: fixed !important;
      word-wrap: break-word !important;
    }
    .print-section .items-table th,
    .print-section .items-table td,
    .print-section .detail-items-table th,
    .print-section .detail-items-table td {
      border: 1px solid #000 !important;
      padding: 3px 4px !important;
      font-size: 8pt !important;
      word-wrap: break-word !important;
      text-align: left !important;
      vertical-align: top !important;
      color: black !important;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .print-section .items-table td:nth-child(3),
    .print-section .items-table td:nth-child(4),
    .print-section .items-table td:nth-child(5),
    .print-section .detail-items-table td:nth-child(3), /* æ•¸é‡æ¬„ */
    .print-section .detail-items-table td:nth-child(4), /* å–®åƒ¹æ¬„ */
    .print-section .detail-items-table td:nth-child(5) { /* ç¸½åƒ¹æ¬„ */
        text-align: right !important;
    }
    .print-section .items-table th,
    .print-section .detail-items-table th {
        font-weight: bold !important;
        text-align: center !important;
    }
    .print-section div[style*="background:#ffff99"],
    .print-section div[style*="background:#f4a460"] {
       border: 1px solid #ccc !important;
       padding: 5px !important;
       margin-top: 10px !important;
       margin-bottom: 10px !important;
    }
     .print-section div[style*="text-align:right"] {
         text-align: right !important;
         font-weight: bold !important;
         margin-top: 10px !important;
     }
     .print-section div[style*="display:flex"] {
         display: block !important; /* æ”¹ç‚º block ä»¥ç°¡åŒ–åˆ—å°ä½ˆå±€ */
     }
     .print-section div[style*="justify-content:space-between"] > div {
         margin-bottom: 5px !important;
     }
     .print-section div[style*="justify-content:space-around"] {
          margin-top: 30px !important;
          padding-top: 15px !important;
          border-top: 1px solid #000 !important;
          display: block !important;
     }
      .print-section div[style*="justify-content:space-around"] > div {
          margin-bottom: 10px !important;
          width: 100% !important;
      }

    /* --- 4. ç¢ºä¿ modal æœ¬èº«åœ¨åˆ—å°æ™‚éš±è— --- */
    #quotation-detail-modal {
        display: none !important;
        visibility: hidden !important;
    }

    }
    /* ================== åˆ—å°æ¨£å¼çµæŸ ================== */
  </style>
</head>
<body>
  <div class="container">
    <h2>ä¼°åƒ¹å–®æ¸…å–® ğŸ“„</h2>

    <!-- å°è¦½åˆ— -->
    <div class="navbar">
      <button class="hamburger-menu" id="hamburger-menu">â˜°</button>
      <div class="nav-links" id="nav-links">
        <a href="notes.html" class="nav-link">æˆ‘çš„ç­†è¨˜</a>
        <a href="trash.html" class="nav-link">å›æ”¶ç«™</a>
        <a href="quotation.html" class="nav-link">ä¼°åƒ¹å–®</a>
        <a href="quotation-list.html" class="nav-link active">ä¼°åƒ¹å–®æ¸…å–®</a>
        <a href="salary.html" class="nav-link">è–ªè³‡ç®¡ç†</a>
        <button id="logout-btn" class="nav-link" onclick="signOut()" style="margin-left:auto;">ç™»å‡º</button>
      </div>
    </div>

    <!-- ä¼°åƒ¹å–®åˆ—è¡¨ -->
    <div id="quotation-list-container">
      <table class="quotation-list-table">
        <thead>
          <tr>
            <th>å ±åƒ¹åç¨±</th>
            <th>å®¢æˆ¶åç¨±</th>
            <th>å ±åƒ¹æ—¥æœŸ</th>
            <th>ç¸½é‡‘é¡</th>
            <th>å»ºç«‹æ™‚é–“</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="quotation-list-body">
          <!-- ä¼°åƒ¹å–®åˆ—è¡¨å°‡å‹•æ…‹è¼‰å…¥é€™è£¡ -->
          <tr><td colspan="6">è¼‰å…¥ä¼°åƒ¹å–®æ¸…å–®ä¸­...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- ä¼°åƒ¹å–®è©³æƒ…å½ˆå‡ºè¦–çª— -->
    <div id="quotation-detail-modal" class="modal">
      <div class="modal-content quotation-detail-content">
        <div class="modal-header quotation-detail-header">
          <h3>ä¼°åƒ¹å–®è©³æƒ…</h3>
          <span class="modal-close quotation-detail-close" id="close-detail-modal">&times;</span>
        </div>
        <div id="quotation-detail-body">
          <!-- ä¼°åƒ¹å–®è©³ç´°å…§å®¹å°‡è¼‰å…¥é€™è£¡ -->
        </div>
         <div class="modal-footer" style="text-align: right; margin-top: 15px;">
             <button id="print-detail-btn" class="button">åˆ—å°æ­¤ä¼°åƒ¹å–®</button>
             <button id="delete-detail-btn" class="danger">åˆªé™¤æ­¤ä¼°åƒ¹å–®</button>
         </div>
      </div>
    </div>


    <!-- è¼‰å…¥ä¸­é¡¯ç¤º -->
    <div class="loading-overlay" id="loading-overlay">
      <div class="loading-spinner"></div>
      <div class="loading-text">è™•ç†ä¸­...</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="script.js"></script>
  <script>
    let currentUser;
    let allQuotations = []; // ç”¨æ–¼å„²å­˜æ‰€æœ‰è¼‰å…¥çš„ä¼°åƒ¹å–®æ•¸æ“š
    let currentDetailQuotationId = null; // ç”¨æ–¼å„²å­˜ç•¶å‰æŸ¥çœ‹è©³æƒ…çš„ä¼°åƒ¹å–® ID

    // é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
    function showLoading() {
      const overlay = document.getElementById('loading-overlay');
      if (overlay) overlay.classList.add('active');
    }

    // éš±è—è¼‰å…¥ä¸­ç‹€æ…‹
    function hideLoading() {
      const overlay = document.getElementById('loading-overlay');
      if (overlay) overlay.classList.remove('active');
    }

    // åˆå§‹åŒ–é é¢
    document.addEventListener('DOMContentLoaded', async () => {
      currentUser = await checkAuthAndRedirect();
      if (!currentUser) return;

      // ç¶å®šç™»å‡ºæŒ‰éˆ•
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) logoutBtn.addEventListener('click', signOut);

      // ç¶å®šé—œé–‰è©³æƒ…è¦–çª—æŒ‰éˆ•
      const closeDetailModalBtn = document.getElementById('close-detail-modal');
      if (closeDetailModalBtn) closeDetailModalBtn.addEventListener('click', closeQuotationDetailModal);

      // ç¶å®šè©³æƒ…è¦–çª—ä¸­çš„åˆªé™¤æŒ‰éˆ•
      const deleteDetailBtn = document.getElementById('delete-detail-btn');
      if (deleteDetailBtn) deleteDetailBtn.addEventListener('click', handleDeleteQuotation);

      // ç¶å®šè©³æƒ…è¦–çª—ä¸­çš„åˆ—å°æŒ‰éˆ•
      const printDetailBtn = document.getElementById('print-detail-btn');
      if (printDetailBtn) printDetailBtn.addEventListener('click', handlePrintQuotationDetail);


      // è¼‰å…¥ä¼°åƒ¹å–®åˆ—è¡¨
      await loadQuotationList();
    });

    // è¼‰å…¥ä¼°åƒ¹å–®åˆ—è¡¨æ•¸æ“š
    async function loadQuotationList() {
      showLoading();
      try {
        const { data, error } = await window.supabaseClient
          .from('quotations') // å¾ 'quotations' è¡¨è®€å–
          .select('id, quotation_title, customer_name, date, total, created_at') // é¸æ“‡éœ€è¦çš„æ¬„ä½
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false }); // æŒ‰å»ºç«‹æ™‚é–“é™åºæ’åˆ—

        if (error) throw error;

        allQuotations = data || []; // å„²å­˜æ•¸æ“š
        renderQuotationList(allQuotations);

      } catch (error) {
        console.error('è¼‰å…¥ä¼°åƒ¹å–®åˆ—è¡¨å¤±æ•—ï¼š', error);
        alert('âŒ è¼‰å…¥ä¼°åƒ¹å–®åˆ—è¡¨å¤±æ•—ï¼š' + error.message);
        document.getElementById('quotation-list-body').innerHTML = '<tr><td colspan="6" style="color: red;">ç„¡æ³•è¼‰å…¥ä¼°åƒ¹å–®æ¸…å–®ã€‚</td></tr>';
      } finally {
        hideLoading();
      }
    }

    // æ¸²æŸ“ä¼°åƒ¹å–®åˆ—è¡¨
    function renderQuotationList(quotations) {
      const listBody = document.getElementById('quotation-list-body');
      if (!listBody) return;

      if (quotations.length === 0) {
        listBody.innerHTML = '<tr><td colspan="6">ç›®å‰æ²’æœ‰ä¼°åƒ¹å–®è¨˜éŒ„ã€‚</td></tr>';
        return;
      }

      listBody.innerHTML = ''; // æ¸…ç©ºç¾æœ‰åˆ—è¡¨

      quotations.forEach(q => {
        const row = listBody.insertRow();
        row.innerHTML = `
          <td>${q.quotation_title || 'N/A'}</td>
          <td>${q.customer_name || 'N/A'}</td>
          <td>${q.date || 'N/A'}</td>
          <td>${q.total ? q.total.toLocaleString() : 'N/A'}</td>
          <td>${q.created_at ? new Date(q.created_at).toLocaleString() : 'N/A'}</td>
          <td><button class="danger" onclick="deleteQuotation(event, ${q.id})">åˆªé™¤</button></td>
        `;
        // æ·»åŠ é»æ“Šäº‹ä»¶ç›£è½å™¨ä»¥é¡¯ç¤ºè©³æƒ…
        row.addEventListener('click', (event) => {
            // é˜²æ­¢é»æ“Šåˆªé™¤æŒ‰éˆ•æ™‚è§¸ç™¼æ•´è¡Œé»æ“Šäº‹ä»¶
            if (event.target.tagName.toLowerCase() !== 'button') {
                openQuotationDetailModal(q.id);
            }
        });
      });
    }

    // æ‰“é–‹ä¼°åƒ¹å–®è©³æƒ…å½ˆå‡ºè¦–çª—
    async function openQuotationDetailModal(id) {
        showLoading();
        currentDetailQuotationId = id; // å„²å­˜ç•¶å‰æŸ¥çœ‹çš„ ID
        try {
            // å¾ allQuotations ä¸­æŸ¥æ‰¾å®Œæ•´æ•¸æ“šï¼Œå¦‚æœæ‰¾ä¸åˆ°å†å¾è³‡æ–™åº«æŸ¥è©¢
            let quotation = allQuotations.find(q => q.id === id);

            // å¦‚æœåˆ—è¡¨æ•¸æ“šä¸åŒ…å« itemsï¼Œå‰‡éœ€è¦é‡æ–°æŸ¥è©¢
            if (!quotation || !quotation.items) {
                 console.log(`ID ${id} çš„å®Œæ•´æ•¸æ“šä¸åœ¨ allQuotations ä¸­ï¼Œå¾è³‡æ–™åº«æŸ¥è©¢...`);
                 const { data, error } = await window.supabaseClient
                    .from('quotations')
                    .select('*') // ç²å–æ‰€æœ‰æ¬„ä½ï¼ŒåŒ…æ‹¬ items
                    .eq('id', id)
                    .eq('user_id', currentUser.id)
                    .single(); // æœŸæœ›åªè¿”å›ä¸€æ¢è¨˜éŒ„

                 if (error) throw error;
                 if (!data) throw new Error('æ‰¾ä¸åˆ°è©²ä¼°åƒ¹å–®');
                 quotation = data;

                 // æ›´æ–° allQuotations ä¸­çš„æ•¸æ“š (å¯é¸)
                 const index = allQuotations.findIndex(q => q.id === id);
                 if (index !== -1) {
                     allQuotations[index] = quotation;
                 } else {
                     // å¦‚æœåŸå§‹åˆ—è¡¨ä¸­æ²’æœ‰ï¼Œå¯èƒ½éœ€è¦é‡æ–°æ’åºæˆ–æ·»åŠ 
                     // ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œé€™è£¡æš«ä¸è™•ç†
                 }
            } else {
                 console.log(`å¾ allQuotations ä¸­æ‰¾åˆ° ID ${id} çš„å®Œæ•´æ•¸æ“šã€‚`);
            }


            const detailBody = document.getElementById('quotation-detail-body');
            const modal = document.getElementById('quotation-detail-modal');

            if (!detailBody || !modal) {
                console.error('æ‰¾ä¸åˆ°è©³æƒ…è¦–çª—å…ƒç´ ');
                hideLoading();
                return;
            }

            // ç”Ÿæˆè©³æƒ… HTML (èˆ‡ quotation.html çš„ preview é¡ä¼¼ï¼Œä½†ä½¿ç”¨æŸ¥è©¢åˆ°çš„æ•¸æ“š)
            let detailHtml = `
                <h4>åŸºæœ¬è³‡è¨Š</h4>
                <p><strong>å ±åƒ¹åç¨±ï¼š</strong> ${quotation.quotation_title || 'N/A'}</p>
                <p><strong>å®¢æˆ¶åç¨±ï¼š</strong> ${quotation.customer_name || 'N/A'}</p>
                <p><strong>è¯çµ¡äººï¼š</strong> ${quotation.contact_person || 'N/A'}</p>
                <p><strong>è¯çµ¡é›»è©±ï¼š</strong> ${quotation.contact_phone || 'N/A'}</p>
                <p><strong>å ±åƒ¹æ—¥æœŸï¼š</strong> ${quotation.date || 'N/A'}</p>
                <p><strong>å»ºç«‹æ™‚é–“ï¼š</strong> ${new Date(quotation.created_at).toLocaleString()}</p>
                <hr>
                <h4>å“é …åˆ—è¡¨</h4>
            `;

            if (quotation.items && Array.isArray(quotation.items) && quotation.items.length > 0) {
                detailHtml += `
                    <table class="detail-items-table">
                        <thead>
                            <tr>
                                <th>åç¨±</th>
                                <th>è¦æ ¼</th>
                                <th>æ•¸é‡</th>
                                <th>å–®åƒ¹</th>
                                <th>ç¸½åƒ¹</th>
                                <th>å‚™è¨»</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                quotation.items.forEach(item => {
                    detailHtml += `
                        <tr>
                            <td>${item.name || ''}</td>
                            <td>${item.spec || ''}</td>
                            <td style="text-align: center;">${item.quantity || 0}</td>
                            <td style="text-align: right;">${(item.price || 0).toFixed(2)}</td>
                            <td style="text-align: right;">${(item.subtotal || 0).toFixed(2)}</td>
                            <td>${item.note || ''}</td>
                        </tr>
                    `;
                });
                detailHtml += `
                        </tbody>
                    </table>
                    <div class="detail-total">ç¸½è¨ˆï¼š${(quotation.total || 0).toLocaleString()} å…ƒ</div>
                `;
            } else {
                detailHtml += '<p>æ²’æœ‰å“é …è³‡æ–™ã€‚</p>';
            }

            detailBody.innerHTML = detailHtml;
            modal.classList.add('active');

        } catch (error) {
            console.error('è¼‰å…¥ä¼°åƒ¹å–®è©³æƒ…å¤±æ•—ï¼š', error);
            alert('âŒ è¼‰å…¥ä¼°åƒ¹å–®è©³æƒ…å¤±æ•—ï¼š' + error.message);
            currentDetailQuotationId = null; // å¤±æ•—æ™‚é‡ç½® ID
        } finally {
            hideLoading();
        }
    }


    // é—œé–‰ä¼°åƒ¹å–®è©³æƒ…å½ˆå‡ºè¦–çª—
    function closeQuotationDetailModal() {
      const modal = document.getElementById('quotation-detail-modal');
      if (modal) modal.classList.remove('active');
      currentDetailQuotationId = null; // æ¸…é™¤ç•¶å‰æŸ¥çœ‹çš„ ID
    }

    // åˆªé™¤ä¼°åƒ¹å–® (åˆ—è¡¨ä¸­çš„æŒ‰éˆ•)
    async function deleteQuotation(event, id) {
        event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°è¡Œé»æ“Šäº‹ä»¶

        if (!confirm(`ç¢ºå®šè¦åˆªé™¤é€™ç­†ä¼°åƒ¹å–® (ID: ${id}) å—ï¼Ÿ`)) return;

        showLoading();
        try {
            const { error } = await window.supabaseClient
                .from('quotations')
                .delete()
                .eq('id', id)
                .eq('user_id', currentUser.id); // ç¢ºä¿åªèƒ½åˆªé™¤è‡ªå·±çš„è¨˜éŒ„

            if (error) throw error;

            // å¾ allQuotations é™£åˆ—ä¸­ç§»é™¤
            allQuotations = allQuotations.filter(q => q.id !== id);
            // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            renderQuotationList(allQuotations);

        } catch (error) {
            console.error('åˆªé™¤ä¼°åƒ¹å–®å¤±æ•—ï¼š', error);
            alert('âŒ åˆªé™¤ä¼°åƒ¹å–®å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    }

    // è™•ç†å¾è©³æƒ…è¦–çª—åˆªé™¤ä¼°åƒ¹å–®
    async function handleDeleteQuotation() {
        if (!currentDetailQuotationId) return;
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤é€™ç­†ä¼°åƒ¹å–® (ID: ${currentDetailQuotationId}) å—ï¼Ÿ`)) return;

        showLoading();
        try {
            const { error } = await window.supabaseClient
                .from('quotations')
                .delete()
                .eq('id', currentDetailQuotationId)
                .eq('user_id', currentUser.id);

            if (error) throw error;

            // å¾ allQuotations é™£åˆ—ä¸­ç§»é™¤
            allQuotations = allQuotations.filter(q => q.id !== currentDetailQuotationId);
            // é—œé–‰è©³æƒ…è¦–çª—
            closeQuotationDetailModal();
            // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            renderQuotationList(allQuotations);

        } catch (error) {
            console.error('åˆªé™¤ä¼°åƒ¹å–®å¤±æ•—ï¼š', error);
            alert('âŒ åˆªé™¤ä¼°åƒ¹å–®å¤±æ•—ï¼š' + error.message);
        } finally {
            hideLoading();
            currentDetailQuotationId = null; // ç„¡è«–å¦‚ä½•éƒ½æ¸…é™¤ ID
        }
    }

    // è™•ç†å¾è©³æƒ…è¦–çª—åˆ—å°ä¼°åƒ¹å–® (ä½¿å…¶èˆ‡ quotation.html ä¸€è‡´)
    function handlePrintQuotationDetail() {
        if (!currentDetailQuotationId) {
            alert('æ²’æœ‰é¸å®šçš„ä¼°åƒ¹å–®å¯ä¾›åˆ—å°ã€‚');
            return;
        }

        // å¾ allQuotations ç²å–ç•¶å‰æŸ¥çœ‹çš„å®Œæ•´ä¼°åƒ¹å–®æ•¸æ“š
        const quotation = allQuotations.find(q => q.id === currentDetailQuotationId);

        if (!quotation) {
            alert('æ‰¾ä¸åˆ°ä¼°åƒ¹å–®è³‡æ–™ï¼Œç„¡æ³•åˆ—å°ã€‚');
            return;
        }

        // ç”Ÿæˆå®Œæ•´çš„åˆ—å° HTML çµæ§‹ (é¡ä¼¼ quotation.html çš„ previewQuotation)
        let printHtml = `
            <div style="text-align:center; font-size:24px; font-weight:bold; margin-bottom:10px;">å¤§ç™¼é‹¼æ§‹æœ‰é™å…¬å¸</div>
            <div style="text-align:center; font-size:18px; background:#f4a460; padding:5px; margin-bottom:10px;">å ±åƒ¹å–®</div>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
              <div>
                <p><strong>å ±åƒ¹åç¨±ï¼š</strong>${quotation.quotation_title || 'N/A'}</p>
                <p><strong>å®¢æˆ¶åç¨±ï¼š</strong>${quotation.customer_name || 'N/A'}</p>
                <p><strong>è¯çµ¡äººï¼š</strong>${quotation.contact_person || 'N/A'}</p>
                <p><strong>é›»è©±ï¼š</strong>${quotation.contact_phone || 'N/A'}</p>
              </div>
              <div>
                <p><strong>å ±åƒ¹æ—¥æœŸï¼š</strong>${quotation.date || 'N/A'}</p>
              </div>
            </div>
            <div style="background:#ffff99; padding:5px; margin-bottom:10px;">
              <p><strong>å ±åƒ¹æ–¹è³‡è¨Šï¼š</strong></p>
              <p>å…¬å¸åç¨±ï¼šå¤§ç™¼é‹¼æ§‹æœ‰é™å…¬å¸</p>
              <p>åœ°å€ï¼šå½°åŒ–ç¸£åŸ¤é ­é„‰å¹³åŸæ‘ç¨»é¦™è·¯464å··28è™Ÿ</p>
              <p>é›»è©±ï¼š09-20552261</p>
            </div>
            <table class="items-table detail-items-table" style="width:100%; border-collapse: collapse;">
              <thead>
                <tr>
                  <th style="border: 1px solid #000; padding: 5px; background-color: #eee;">åç¨±</th>
                  <th style="border: 1px solid #000; padding: 5px; background-color: #eee;">è¦æ ¼</th>
                  <th style="border: 1px solid #000; padding: 5px; background-color: #eee; text-align: center;">æ•¸é‡</th>
                  <th style="border: 1px solid #000; padding: 5px; background-color: #eee; text-align: right;">å–®åƒ¹</th>
                  <th style="border: 1px solid #000; padding: 5px; background-color: #eee; text-align: right;">ç¸½åƒ¹</th>
                  <th style="border: 1px solid #000; padding: 5px; background-color: #eee;">å‚™è¨»</th>
                </tr>
              </thead>
              <tbody>
        `;

        if (quotation.items && Array.isArray(quotation.items)) {
            quotation.items.forEach(item => {
                printHtml += `
                  <tr>
                    <td style="border: 1px solid #000; padding: 5px;">${item.name || ''}</td>
                    <td style="border: 1px solid #000; padding: 5px;">${item.spec || ''}</td>
                    <td style="border: 1px solid #000; padding: 5px; text-align: center;">${item.quantity || 0}</td>
                    <td style="border: 1px solid #000; padding: 5px; text-align: right;">${(item.price || 0).toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 5px; text-align: right;">${(item.subtotal || 0).toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 5px;">${item.note || ''}</td>
                  </tr>
                `;
            });
        }

        printHtml += `
              </tbody>
            </table>
            <div style="margin-top:10px; font-weight:bold; text-align:right; padding-right:10px;">ç¸½è¨ˆæ–°å°å¹£ï¼š${(quotation.total || 0).toLocaleString()}å…ƒæ•´</div>
            <div style="background:#ffff99; padding:5px; margin-top:10px;">
              <p><strong>é™„è¨»ï¼š</strong></p>
              <p>1.ä»¥ä¸Šå–®åƒ¹æœªç¨…åƒ¹.  ä»¥ä¸Šä¼°ç®—å ±åƒ¹ä¸å«æœªè©³åˆ—ä¹‹å·¥é …å·¥ç¨‹ã€‚</p>
              <p>2.ç°½ç´„åŒæ™‚æ”¯ä»˜ç¸½å·¥ç¨‹æ¬¾ä¹‹30%(ç¾é‡‘ç¥¨)</p>
              <p>3.è£½ä½œå®Œæˆé€²å ´æŒ‰è£å†æ”¯ä»˜ç¸½å·¥ç¨‹æ¬¾ä¹‹40%(ç¾é‡‘ç¥¨)</p>
              <p>4.æŒ‰è£å®Œæˆå†æ”¯ä»˜ç¸½å·¥ç¨‹æ¬¾ä¹‹30%(ç¾é‡‘ç¥¨)</p>
              <p>5.æœ¬å·¥ç¨‹7å¤©å…§é©—æ”¶å®Œç•¢ä»˜æ¸…å°¾æ¬¾(ç¾é‡‘ç¥¨)</p>
              <p>6.å¦‚å·²å®Œæˆå» å…§è£½ä½œï¼ŒæƒŸå› å…¶ä»–å·¥ç¨‹å»¶èª¤ï¼Œè‡´ç„¡æ³•é€²å ´å®‰è£ï¼Œä»é ˆä¾é …2æ”¯ä»˜ç¸½å·¥ç¨‹æ¬¾ä¹‹40%</p>
              <p>7.æ­¤å–®ç¢ºèªå›å‚³å¾Œï¼Œç¤ºç‚ºè²´å¸éµå®ˆä»¥ä¸Šä¹‹ç´„å®šã€‚</p>
            </div>
            <div style="margin-top:40px; padding-top: 20px; border-top: 1px solid #ccc; display:flex; justify-content:space-around;">
              <div>ä»˜æ¬¾æ–¹å¼ï¼š_________________________</div>
              <div>å®¢æˆ¶ç¢ºèªç°½åï¼š_________________________</div>
            </div>
        `;

        // å‰µå»ºè‡¨æ™‚åˆ—å°å€å¡Š
        const printSection = document.createElement('div');
        printSection.innerHTML = printHtml;
        printSection.classList.add('print-section'); // æ‡‰ç”¨åˆ—å°æ¨£å¼
        printSection.style.position = 'absolute';
        printSection.style.left = '-9999px'; // ç§»å‡ºç•«é¢å¤–
        document.body.appendChild(printSection);

        // ä½¿ç”¨å»¶é²ç¢ºä¿å…§å®¹æ¸²æŸ“
        setTimeout(() => {
            try {
                window.print(); // è§¸ç™¼ç€è¦½å™¨åˆ—å°
            } catch (error) {
                console.error('åˆ—å°å¤±æ•—:', error);
                alert('åˆ—å°å¤±æ•—: ' + error.message);
            } finally {
                // åˆ—å°å¾Œç§»é™¤è‡¨æ™‚å€å¡Š
                document.body.removeChild(printSection);
            }
        }, 100);
    }


  </script>
</body>
</html>
